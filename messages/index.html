<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Private Messaging</title>
        <link rel="stylesheet" href="style.css" />
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    </head>
    <body>
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>Private Messages</h1>
                <p>Connect privately with community members</p>
            </div>

            <!-- Top Bar -->
            <div class="top-bar hidden" id="topBar">
                <div class="user-info-display">
                    <div class="top-bar-avatar" id="topBarAvatar"></div>
                    <div>
                        <div id="topBarName" style="font-weight: 600"></div>
                        <div style="font-size: 12px; color: #666">Online</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px">
                    <button class="secondary-btn" onclick="showBlockedUsers()" style="width: auto; padding: 10px 20px">
                        Blocked Users
                    </button>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Login Form -->
            <div class="auth-section centered" id="loginForm">
                <div class="auth-card">
                    <h2>Welcome Back</h2>
                    <div class="auth-form">
                        <div class="input-group">
                            <input type="email" id="email" placeholder="Email" />
                        </div>
                        <div class="input-group">
                            <input type="password" id="password" placeholder="Password" />
                        </div>
                        <button onclick="login()">Login</button>
                        <p style="margin-top: 20px">Don't have an account?</p>
                        <button class="secondary-btn" onclick="showSignup()">Sign Up</button>
                    </div>
                </div>
            </div>

            <!-- Signup Form -->
            <div class="auth-section centered hidden" id="signupForm">
                <div class="auth-card">
                    <h2>Create Account</h2>
                    <div class="auth-form">
                        <div class="input-group">
                            <input type="text" id="signupName" placeholder="Full Name" />
                        </div>
                        <div class="input-group">
                            <input type="email" id="signupEmail" placeholder="Email" />
                        </div>
                        <div class="input-group">
                            <input type="password" id="signupPassword" placeholder="Password" />
                        </div>
                        <button onclick="signup()">Sign Up</button>
                        <p style="margin-top: 20px">Already have an account?</p>
                        <button class="secondary-btn" onclick="showLogin()">Login</button>
                    </div>
                </div>
            </div>

            <!-- Pending Approval -->
            <div class="pending-approval centered hidden" id="adminNotice">
                <h2>‚è≥ Pending Approval</h2>
                <p>Your account is awaiting admin approval. You'll be able to access messaging once approved.</p>
                <button class="secondary-btn" style="margin-top: 20px" onclick="logout()">Logout</button>
            </div>

            <!-- Main Chat Interface -->
            <div class="container hidden" id="mainContent">
                <div class="chat-container">
                    <!-- Users List -->
                    <div class="users-list">
                        <div style="padding: 15px; border-bottom: 2px solid #1e90ff; background: white">
                            <input
                                type="text"
                                id="userSearch"
                                placeholder="Search users..."
                                style="margin: 0"
                                oninput="filterUsers()" />
                        </div>
                        <div id="usersList"></div>
                    </div>

                    <!-- Chat Area -->
                    <div class="chat-area">
                        <div
                            id="chatHeader"
                            class="hidden"
                            style="
                                padding: 15px 30px;
                                background: white;
                                border-bottom: 1px solid #e0e0e0;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            ">
                            <div style="display: flex; gap: 12px; align-items: center">
                                <div class="post-avatar" id="chatUserAvatar"></div>
                                <div>
                                    <div id="chatUserName" style="font-weight: 600"></div>
                                    <div id="chatUserStatus" style="font-size: 12px; color: #666"></div>
                                </div>
                            </div>
                            <button class="btn-danger" onclick="blockUser()" style="padding: 8px 15px; font-size: 14px">
                                Block User
                            </button>
                        </div>

                        <div id="messagesContainer" class="messages-container">
                            <div class="empty-state">
                                <h3>üëã Welcome to Private Messages</h3>
                                <p>Select a user from the left to start chatting</p>
                            </div>
                        </div>

                        <div
                            id="messageInput"
                            class="hidden"
                            style="padding: 20px 30px; background: white; border-top: 1px solid #e0e0e0">
                            <div style="display: flex; gap: 10px; align-items: end">
                                <div style="flex: 1">
                                    <textarea
                                        id="messageText"
                                        placeholder="Type a message..."
                                        rows="2"
                                        style="margin: 0; resize: none"></textarea>
                                    <input
                                        type="file"
                                        id="messageImage"
                                        accept="image/*"
                                        style="margin-top: 10px; display: none"
                                        onchange="handleImageSelect()" />
                                    <div
                                        id="imagePreview"
                                        class="hidden"
                                        style="margin-top: 10px; position: relative; display: inline-block">
                                        <img id="previewImg" style="max-width: 150px; border-radius: 8px" />
                                        <button
                                            onclick="removeImagePreview()"
                                            style="
                                                position: absolute;
                                                top: 5px;
                                                right: 5px;
                                                width: auto;
                                                padding: 5px 10px;
                                                background: #ef4444;
                                                font-size: 12px;
                                            ">
                                            ‚úï
                                        </button>
                                    </div>
                                    <div
                                        id="imageCooldown"
                                        class="hidden"
                                        style="
                                            margin-top: 10px;
                                            padding: 10px;
                                            background: #fff3cd;
                                            border: 1px solid #ffc107;
                                            border-radius: 8px;
                                            font-size: 14px;
                                        ">
                                        ‚è≥ Please wait <span id="cooldownTimer"></span> seconds before sending another
                                        image
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 10px">
                                    <button
                                        class="secondary-btn"
                                        onclick="document.getElementById('messageImage').click()"
                                        style="width: 50px; height: 50px; padding: 0; font-size: 20px">
                                        üì∑
                                    </button>
                                    <button
                                        onclick="sendMessage()"
                                        style="width: 50px; height: 50px; padding: 0; font-size: 20px">
                                        üì§
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blocked Users Modal -->
        <div class="fullscreen-overlay" id="blockedUsersModal">
            <div class="post" style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px">
                    <h2>Blocked Users</h2>
                    <button class="btn-danger" onclick="hideBlockedUsers()" style="width: auto; padding: 8px 15px">
                        Close
                    </button>
                </div>
                <div id="blockedUsersList"></div>
            </div>
        </div>

        <!-- Image Preview Modal -->
        <div class="image-modal" id="imageModal" onclick="closeImageModal()">
            <img id="modalImage" style="max-width: 90%; max-height: 90vh; border-radius: 12px" />
        </div>

        <script>
            // Firebase config
            const firebaseConfig = {
                apiKey: "AIzaSyDzQlAqhCeytCLEYafboYGpFu6pY3Kv9WE",
                authDomain: "allforonemedia-9a7d8.firebaseapp.com",
                projectId: "allforonemedia-9a7d8",
                storageBucket: "allforonemedia-9a7d8.firebasestorage.app",
                messagingSenderId: "892787060584",
                appId: "1:892787060584:web:e65609062592f9ba96f0dd",
                measurementId: "G-JSXKLMBRLC"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            const CLOUDINARY_CLOUD_NAME = "dgrmpcha9";
            const CLOUDINARY_UPLOAD_PRESET = "AllForOne Posts";
            const IMAGE_COOLDOWN = 30; // 30 seconds between images

            let currentUser = null;
            let selectedUser = null;
            let allUsers = [];
            let lastImageTime = 0;
            let cooldownInterval = null;
            let selectedImageFile = null;

            // Check for existing session
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDoc = await db.collection("users").doc(user.uid).get();
                    if (userDoc.exists && userDoc.data().approved) {
                        currentUser = { uid: user.uid, ...userDoc.data() };
                        showMainContent();
                    } else if (userDoc.exists) {
                        document.getElementById("loginForm").classList.add("hidden");
                        document.getElementById("signupForm").classList.add("hidden");
                        document.getElementById("adminNotice").classList.remove("hidden");
                    } else {
                        document.getElementById("loginForm").classList.remove("hidden");
                    }
                } else {
                    document.getElementById("loginForm").classList.remove("hidden");
                }
            });

            function showSignup() {
                document.getElementById("loginForm").classList.add("hidden");
                document.getElementById("signupForm").classList.remove("hidden");
            }

            function showLogin() {
                document.getElementById("signupForm").classList.add("hidden");
                document.getElementById("loginForm").classList.remove("hidden");
            }

            async function signup() {
                const name = document.getElementById("signupName").value;
                const email = document.getElementById("signupEmail").value;
                const password = document.getElementById("signupPassword").value;

                if (!name || !email || !password) {
                    alert("Please fill in all fields");
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    await db.collection("users").doc(user.uid).set({
                        name: name,
                        email: email,
                        approved: false,
                        isAdmin: false,
                        blockedUsers: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("Signup successful! Await admin approval.");
                    showLogin();
                } catch (error) {
                    alert(error.message);
                }
            }

            async function login() {
                const email = document.getElementById("email").value;
                const password = document.getElementById("password").value;
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    const userDoc = await db.collection("users").doc(user.uid).get();

                    if (userDoc.exists && userDoc.data().approved) {
                        currentUser = { uid: user.uid, ...userDoc.data() };
                        showMainContent();
                    } else {
                        document.getElementById("loginForm").classList.add("hidden");
                        document.getElementById("adminNotice").classList.remove("hidden");
                    }
                } catch (error) {
                    alert(error.message);
                }
            }

            function logout() {
                auth.signOut();
                location.reload();
            }

            async function showMainContent() {
                document.getElementById("loginForm").classList.add("hidden");
                document.getElementById("signupForm").classList.add("hidden");
                document.getElementById("adminNotice").classList.add("hidden");
                document.getElementById("topBar").classList.remove("hidden");
                document.getElementById("mainContent").classList.remove("hidden");

                document.getElementById("topBarAvatar").textContent = currentUser.name.charAt(0).toUpperCase();
                document.getElementById("topBarName").textContent = currentUser.name;

                // Initialize blocked list if it doesn't exist
                if (!currentUser.blockedUsers) {
                    await db.collection("users").doc(currentUser.uid).update({ blockedUsers: [] });
                    currentUser.blockedUsers = [];
                }

                loadUsers();
            }

            async function loadUsers() {
                const usersSnapshot = await db.collection("users").where("approved", "==", true).get();
                allUsers = [];

                usersSnapshot.forEach((doc) => {
                    if (doc.id !== currentUser.uid) {
                        allUsers.push({ uid: doc.id, ...doc.data() });
                    }
                });

                displayUsers(allUsers);
            }

            function displayUsers(users) {
                const usersList = document.getElementById("usersList");
                const blockedUsers = currentUser.blockedUsers || [];

                // Filter out blocked users
                const filteredUsers = users.filter((user) => !blockedUsers.includes(user.uid));

                usersList.innerHTML = "";
                filteredUsers.forEach((user) => {
                    const div = document.createElement("div");
                    div.className = "user-item";
                    if (selectedUser && selectedUser.uid === user.uid) {
                        div.classList.add("active");
                    }

                    div.innerHTML = `
        <div class="user-avatar" style="width: 45px; height: 45px; font-size: 20px;">
          ${user.name.charAt(0).toUpperCase()}
        </div>
        <div style="flex: 1;">
          <div style="font-weight: 600;">${user.name}</div>
          <div style="font-size: 12px; color: #666;">${user.isAdmin ? "üëë Admin" : "Member"}</div>
        </div>
      `;

                    div.onclick = () => selectUser(user);
                    usersList.appendChild(div);
                });

                if (filteredUsers.length === 0) {
                    usersList.innerHTML = '<div class="empty-state"><p>No users available</p></div>';
                }
            }

            function filterUsers() {
                const search = document.getElementById("userSearch").value.toLowerCase();
                const filtered = allUsers.filter((user) => user.name.toLowerCase().includes(search));
                displayUsers(filtered);
            }

            function selectUser(user) {
                selectedUser = user;

                // Update chat header
                document.getElementById("chatHeader").classList.remove("hidden");
                document.getElementById("chatUserAvatar").textContent = user.name.charAt(0).toUpperCase();
                document.getElementById("chatUserName").textContent = user.name;
                document.getElementById("chatUserStatus").textContent = user.isAdmin ? "üëë Admin" : "Member";

                // Show message input
                document.getElementById("messageInput").classList.remove("hidden");

                // Update active user in list
                displayUsers(allUsers);

                // Load messages
                loadMessages();
            }

            function loadMessages() {
                const messagesContainer = document.getElementById("messagesContainer");
                messagesContainer.innerHTML = "";

                // Create a conversation ID (sorted UIDs to ensure consistency)
                const conversationId = [currentUser.uid, selectedUser.uid].sort().join("_");

                db.collection("messages")
                    .where("conversationId", "==", conversationId)
                    .onSnapshot(
                        (snapshot) => {
                            messagesContainer.innerHTML = "";

                            // Sort messages by timestamp manually
                            const messages = [];
                            snapshot.forEach((doc) => {
                                messages.push({ id: doc.id, ...doc.data() });
                            });

                            // Sort by timestamp, putting null timestamps (new messages) at the end
                            messages.sort((a, b) => {
                                if (!a.timestamp) return 1;
                                if (!b.timestamp) return -1;
                                return a.timestamp.toMillis() - b.timestamp.toMillis();
                            });

                            messages.forEach((msg) => {
                                const isSent = msg.senderId === currentUser.uid;

                                const msgDiv = document.createElement("div");
                                msgDiv.className = `message ${isSent ? "sent" : "received"}`;

                                const bubble = document.createElement("div");
                                bubble.className = "message-bubble";

                                if (msg.text) {
                                    const textP = document.createElement("p");
                                    textP.textContent = msg.text;
                                    textP.style.margin = "0";
                                    bubble.appendChild(textP);
                                }

                                if (msg.imageUrl) {
                                    const img = document.createElement("img");
                                    img.src = msg.imageUrl;
                                    img.className = "message-image";
                                    img.style.marginTop = msg.text ? "10px" : "0";
                                    img.style.cursor = "pointer";
                                    img.onclick = () => openImageModal(msg.imageUrl);
                                    bubble.appendChild(img);
                                }

                                const time = document.createElement("div");
                                time.style.fontSize = "11px";
                                time.style.opacity = "0.7";
                                time.style.marginTop = "5px";
                                time.textContent = msg.timestamp
                                    ? new Date(msg.timestamp.toDate()).toLocaleTimeString()
                                    : "Just now";
                                bubble.appendChild(time);

                                msgDiv.appendChild(bubble);
                                messagesContainer.appendChild(msgDiv);
                            });

                            // Scroll to bottom
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        },
                        (error) => {
                            console.error("Error loading messages:", error);
                            messagesContainer.innerHTML =
                                '<div class="empty-state"><p style="color: #ef4444;">Error loading messages. Please refresh the page.</p></div>';
                        }
                    );
            }

            function handleImageSelect() {
                const file = document.getElementById("messageImage").files[0];
                if (file) {
                    selectedImageFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById("previewImg").src = e.target.result;
                        document.getElementById("imagePreview").classList.remove("hidden");
                    };
                    reader.readAsDataURL(file);
                }
            }

            function removeImagePreview() {
                selectedImageFile = null;
                document.getElementById("messageImage").value = "";
                document.getElementById("imagePreview").classList.add("hidden");
            }

            async function sendMessage() {
                const text = document.getElementById("messageText").value.trim();

                if (!text && !selectedImageFile) {
                    alert("Please type a message or select an image");
                    return;
                }

                if (!selectedUser) {
                    alert("Please select a user to message");
                    return;
                }

                // Check image cooldown
                if (selectedImageFile) {
                    const now = Date.now();
                    const timeSinceLastImage = (now - lastImageTime) / 1000;

                    if (timeSinceLastImage < IMAGE_COOLDOWN) {
                        const remaining = Math.ceil(IMAGE_COOLDOWN - timeSinceLastImage);
                        startCooldownTimer(remaining);
                        return;
                    }
                }

                let imageUrl = "";

                // Upload image if selected
                if (selectedImageFile) {
                    const formData = new FormData();
                    formData.append("file", selectedImageFile);
                    formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

                    try {
                        const response = await fetch(
                            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`,
                            {
                                method: "POST",
                                body: formData
                            }
                        );
                        const data = await response.json();
                        imageUrl = data.secure_url;
                        lastImageTime = Date.now();
                    } catch (error) {
                        alert("Failed to upload image. Please try again.");
                        return;
                    }
                }

                // Create conversation ID
                const conversationId = [currentUser.uid, selectedUser.uid].sort().join("_");

                // Send message
                await db.collection("messages").add({
                    conversationId: conversationId,
                    senderId: currentUser.uid,
                    receiverId: selectedUser.uid,
                    senderName: currentUser.name,
                    text: text,
                    imageUrl: imageUrl,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Clear inputs
                document.getElementById("messageText").value = "";
                removeImagePreview();
            }

            function startCooldownTimer(seconds) {
                document.getElementById("imageCooldown").classList.remove("hidden");
                document.getElementById("cooldownTimer").textContent = seconds;

                if (cooldownInterval) clearInterval(cooldownInterval);

                cooldownInterval = setInterval(() => {
                    seconds--;
                    document.getElementById("cooldownTimer").textContent = seconds;

                    if (seconds <= 0) {
                        clearInterval(cooldownInterval);
                        document.getElementById("imageCooldown").classList.add("hidden");
                    }
                }, 1000);
            }

            async function blockUser() {
                if (!selectedUser) return;

                if (
                    confirm(
                        `Are you sure you want to block ${selectedUser.name}? You won't be able to message each other.`
                    )
                ) {
                    const blockedUsers = currentUser.blockedUsers || [];
                    blockedUsers.push(selectedUser.uid);

                    await db.collection("users").doc(currentUser.uid).update({ blockedUsers });
                    currentUser.blockedUsers = blockedUsers;

                    // Also add current user to the other user's blocked list
                    const otherUserDoc = await db.collection("users").doc(selectedUser.uid).get();
                    const otherBlockedUsers = otherUserDoc.data().blockedUsers || [];
                    if (!otherBlockedUsers.includes(currentUser.uid)) {
                        otherBlockedUsers.push(currentUser.uid);
                        await db.collection("users").doc(selectedUser.uid).update({ blockedUsers: otherBlockedUsers });
                    }

                    alert(`${selectedUser.name} has been blocked`);
                    selectedUser = null;
                    document.getElementById("chatHeader").classList.add("hidden");
                    document.getElementById("messageInput").classList.add("hidden");
                    document.getElementById("messagesContainer").innerHTML =
                        '<div class="empty-state"><h3>User Blocked</h3><p>Select another user to chat with</p></div>';

                    loadUsers();
                }
            }

            function showBlockedUsers() {
                document.getElementById("blockedUsersModal").classList.add("active");
                loadBlockedUsers();
            }

            function hideBlockedUsers() {
                document.getElementById("blockedUsersModal").classList.remove("active");
            }

            async function loadBlockedUsers() {
                const blockedUsersList = document.getElementById("blockedUsersList");
                const blockedUsers = currentUser.blockedUsers || [];

                if (blockedUsers.length === 0) {
                    blockedUsersList.innerHTML = '<div class="empty-state"><p>No blocked users</p></div>';
                    return;
                }

                blockedUsersList.innerHTML = "";

                for (const uid of blockedUsers) {
                    const userDoc = await db.collection("users").doc(uid).get();
                    if (userDoc.exists) {
                        const user = userDoc.data();
                        const div = document.createElement("div");
                        div.style.cssText =
                            "background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;";
                        div.innerHTML = `
          <div style="display: flex; gap: 12px; align-items: center;">
            <div class="user-avatar" style="width: 40px; height: 40px; font-size: 18px;">
              ${user.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <div style="font-weight: 600;">${user.name}</div>
              <div style="font-size: 12px; color: #666;">${user.email}</div>
            </div>
          </div>
          <button class="secondary-btn" style="width: auto; padding: 8px 15px; font-size: 14px;" onclick="unblockUser('${uid}')">Unblock</button>
        `;
                        blockedUsersList.appendChild(div);
                    }
                }
            }

            async function unblockUser(uid) {
                if (confirm("Are you sure you want to unblock this user?")) {
                    let blockedUsers = currentUser.blockedUsers || [];
                    blockedUsers = blockedUsers.filter((id) => id !== uid);

                    await db.collection("users").doc(currentUser.uid).update({ blockedUsers });
                    currentUser.blockedUsers = blockedUsers;

                    // Remove current user from other user's blocked list
                    const otherUserDoc = await db.collection("users").doc(uid).get();
                    let otherBlockedUsers = otherUserDoc.data().blockedUsers || [];
                    otherBlockedUsers = otherBlockedUsers.filter((id) => id !== currentUser.uid);
                    await db.collection("users").doc(uid).update({ blockedUsers: otherBlockedUsers });

                    alert("User unblocked!");
                    loadBlockedUsers();
                    loadUsers();
                }
            }

            function openImageModal(url) {
                document.getElementById("modalImage").src = url;
                document.getElementById("imageModal").classList.add("active");
            }

            function closeImageModal() {
                document.getElementById("imageModal").classList.remove("active");
            }

            // Allow Enter to send message (Shift+Enter for new line)
            document.addEventListener("DOMContentLoaded", () => {
                const textarea = document.getElementById("messageText");
                if (textarea) {
                    textarea.addEventListener("keydown", (e) => {
                        if (e.key === "Enter" && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    });
                }
            });
        </script>
    </body>
</html>
