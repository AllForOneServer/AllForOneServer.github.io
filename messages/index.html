<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AllForOne Messages</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: #f9f9f9; color: #1c1c1c; min-height: 100vh; margin: 0; }
            .container { width: 100%; min-height: 100vh; background: white; display: flex; flex-direction: column; }
            .header { background: linear-gradient(135deg, #1e90ff 0%, #0b5394 100%); padding: 15px 30px; color: white; flex-shrink: 0; }
            .header h1 { font-size: 24px; font-weight: 600; margin-bottom: 3px; }
            .header p { font-size: 13px; opacity: 0.9; }
            .auth-section, .pending-section { padding: 30px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; }
            .auth-section h2, .pending-section h2 { color: #1e90ff; margin-bottom: 20px; font-size: 24px; }
            .pending-section p { color: #666; margin-bottom: 20px; line-height: 1.6; }
            .auth-form { max-width: 400px; margin: 0 auto; width: 100%; }
            .input-group { margin-bottom: 15px; }
            input { width: 100%; padding: 14px 18px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: all 0.3s; background: #f9f9f9; }
            input:focus { outline: none; border-color: #1e90ff; background: white; }
            button { width: 100%; padding: 14px; background: #1e90ff; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s; margin-bottom: 10px; }
            button:hover { background: #0b5394; transform: translateY(-1px); }
            button:active { transform: translateY(0); }
            button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
            .secondary-btn { background: #4a86e8; }
            .secondary-btn:hover { background: #0b5394; }
            .logout-btn { background: #ef4444; width: auto; padding: 10px 20px; font-size: 14px; margin: 0; }
            .logout-btn:hover { background: #dc2626; }
            .toggle-link { color: #1e90ff; cursor: pointer; text-decoration: underline; margin-top: 15px; display: inline-block; }
            .toggle-link:hover { color: #0b5394; }
            .chat-container { display: flex; flex: 1; min-height: 500px; }
            .users-list { width: 300px; border-right: 1px solid #e0e0e0; overflow-y: auto; background: #f9f9f9; }
            .user-item { padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; }
            .user-item:hover { background: white; }
            .user-item.active { background: #e3f2fd; border-left: 3px solid #1e90ff; }
            .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4a86e8, #1e90ff); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; }
            .user-info { flex: 1; }
            .user-name { font-weight: 500; color: #1c1c1c; margin-bottom: 2px; }
            .user-status { font-size: 12px; color: #666; }
            .chat-area { flex: 1; display: flex; flex-direction: column; min-height: 500px; }
            .chat-header { padding: 15px 30px; border-bottom: 1px solid #e0e0e0; background: white; flex-shrink: 0; }
            .chat-header h3 { color: #1e90ff; font-size: 18px; }
            .messages-container { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px 30px; background: #f9f9f9; min-height: 300px; }
            .message { margin-bottom: 16px; display: flex; gap: 10px; animation: slideIn 0.3s ease; }
            @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .message.sent { flex-direction: row-reverse; }
            .message-bubble { max-width: 60%; padding: 12px 16px; border-radius: 16px; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; }
            .message.received .message-bubble { background: white; border: 1px solid #e0e0e0; color: #1c1c1c; }
            .message.sent .message-bubble { background: #1e90ff; color: white; }
            .message-meta { font-size: 11px; opacity: 0.7; margin-top: 4px; }
            .message-input-area { padding: 15px 30px; border-top: 1px solid #e0e0e0; background: white; display: flex; gap: 12px; flex-shrink: 0; }
            .message-input { flex: 1; padding: 14px 18px; border: 1px solid #e0e0e0; border-radius: 24px; font-size: 15px; resize: none; font-family: inherit; background: #f9f9f9; }
            .message-input:focus { outline: none; border-color: #1e90ff; background: white; }
            .send-btn { width: 50px; height: 50px; border-radius: 50%; background: #1e90ff; border: none; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
            .send-btn:hover { background: #0b5394; transform: scale(1.05); }
            .send-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
            .image-upload-btn { width: 50px; height: 50px; border-radius: 50%; background: #4a86e8; border: none; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
            .image-upload-btn:hover { background: #0b5394; transform: scale(1.05); }
            .message-image { max-width: 100%; max-height: 300px; width: auto; height: auto; display: block; border-radius: 12px; cursor: pointer; transition: transform 0.2s; }
            .message-image:hover { transform: scale(1.02); }
            .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; align-items: center; justify-content: center; }
            .image-modal.active { display: flex; }
            .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
            .image-modal-close { position: absolute; top: 20px; right: 20px; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
            .error { background: #fff1f2; color: #ef4444; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; border: 1px solid #fee2e2; }
            .success { background: #ecfdf5; color: #047857; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; border: 1px solid #d1fae5; }
            .hidden { display: none !important; }
            .empty-state { text-align: center; padding: 60px 20px; color: #666; }
            .empty-state h3 { color: #1e90ff; margin-bottom: 10px; font-size: 20px; }
            ::-webkit-scrollbar { width: 8px; }
            ::-webkit-scrollbar-track { background: #f9f9f9; }
            ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
            ::-webkit-scrollbar-thumb:hover { background: #999; }
            .loading { text-align: center; padding: 20px; color: #666; }
            .top-bar { padding: 12px 30px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: white; flex-shrink: 0; }
            .user-info-display { display: flex; align-items: center; gap: 12px; }
            .top-bar-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4a86e8, #1e90ff); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>AllForOne Messages</h1>
                <p>Minecraft Education Edition Server - 24/7 Community</p>
            </div>

            <div id="navbar-placeholder"></div>
            <script>
                fetch("https://allforoneserver.github.io/navigation.html")
                    .then((response) => response.text())
                    .then((data) => {
                        document.getElementById("navbar-placeholder").innerHTML = data;
                        const scripts = document.getElementById("navbar-placeholder").getElementsByTagName("script");
                        for (let script of scripts) {
                            try {
                                (0, eval)(script.innerHTML);
                            } catch (e) {
                                console.warn("Navbar script error", e);
                            }
                        }
                    })
                    .catch((error) => console.error("Error loading navbar:", error));
            </script>

            <!-- Auth Section -->
            <div id="authSection" class="auth-section">
                <h2 id="authTitle">Welcome Back</h2>
                <div id="authError" class="error hidden"></div>
                <div id="authSuccess" class="success hidden"></div>
                <div class="auth-form">
                    <div class="input-group">
                        <input type="email" id="emailInput" placeholder="Email Address" />
                    </div>
                    <div class="input-group">
                        <input type="password" id="passwordInput" placeholder="Password" />
                    </div>
                    <div class="input-group hidden" id="displayNameGroup">
                        <input type="text" id="displayNameInput" placeholder="Display Name" />
                    </div>
                    <button id="primaryBtn">Log In</button>
                    <div class="toggle-link" id="toggleAuth">Need an account? Sign up</div>
                </div>
            </div>

            <!-- Pending Approval Section -->
            <div id="pendingSection" class="pending-section hidden">
                <h2>‚è≥ Awaiting Approval</h2>
                <p>Your account has been created successfully!</p>
                <p>Please wait for an administrator to approve your account before you can access the messaging system.</p>
                <p style="font-size: 14px; color: #047857; margin-top: 20px; font-weight: 500">‚úì This page will automatically refresh when you're approved</p>
                <p style="font-size: 14px; color: #999; margin-top: 10px">You can also click "Back to Login" to check manually</p>
                <button id="backToLoginBtn" class="secondary-btn" style="max-width: 300px; margin: 20px auto 0">Back to Login</button>
            </div>

            <!-- Chat Section -->
            <div id="chatSection" class="hidden">
                <div class="top-bar">
                    <div class="user-info-display">
                        <div class="top-bar-avatar" id="userAvatar"></div>
                        <div>
                            <div style="color: #1e90ff; font-weight: 500; font-size: 14px">Logged in as</div>
                            <div style="font-weight: 500" id="currentUserDisplay"></div>
                        </div>
                    </div>
                    <button class="logout-btn" id="logoutBtn">Log Out</button>
                </div>

                <div class="chat-container">
                    <div class="users-list" id="usersList">
                        <div class="loading">Loading users...</div>
                    </div>

                    <div class="chat-area">
                        <div class="chat-header">
                            <h3 id="chatTitle">Select a user to start messaging</h3>
                        </div>
                        <div class="messages-container" id="messagesContainer">
                            <div class="empty-state">
                                <h3>üëã Welcome!</h3>
                                <p>Select a user from the list to start chatting</p>
                            </div>
                        </div>
                        <div class="message-input-area">
                            <input type="file" id="imageInput" accept="image/*" style="display: none" />
                            <button class="image-upload-btn" id="uploadImageBtn" title="Upload image">üì∑</button>
                            <textarea class="message-input" id="messageInput" placeholder="Type a message or paste an image..." rows="1"></textarea>
                            <button class="send-btn" id="sendBtn">‚û§</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Modal -->
        <div class="image-modal" id="imageModal">
            <button class="image-modal-close" id="imageModalClose">√ó</button>
            <img id="imageModalContent" src="" alt="Full size image" />
        </div>

        <script type="module">
            // Firebase App + Auth + Realtime Database only
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import {
                getAuth,
                createUserWithEmailAndPassword,
                signInWithEmailAndPassword,
                signOut,
                onAuthStateChanged,
                updateProfile,
                setPersistence,
                browserLocalPersistence
            } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

            import {
                getDatabase,
                ref as rtdbRef,
                set as rtdbSet,
                get as rtdbGet,
                onValue as rtdbOnValue,
                update as rtdbUpdate,
                push as rtdbPush,
                serverTimestamp as rtdbServerTimestamp
            } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

            const firebaseConfig = {
                apiKey: "AIzaSyDzQlAqhCeytCLEYafboYGpFu6pY3Kv9WE",
                authDomain: "allforonemedia-9a7d8.firebaseapp.com",
                databaseURL: "https://allforonemedia-9a7d8-default-rtdb.firebaseio.com",
                projectId: "allforonemedia-9a7d8",
                storageBucket: "allforonemedia-9a7d8.firebasestorage.app",
                messagingSenderId: "892787060584",
                appId: "1:892787060584:web:e65609062592f9ba96f0dd",
                measurementId: "G-JSXKLMBRLC"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const rtdb = getDatabase(app);

            setPersistence(auth, browserLocalPersistence);

            // Cloudinary config
            const CLOUDINARY_CLOUD_NAME = "dgrmpcha9";
            const CLOUDINARY_UPLOAD_PRESET = "AllForOne Posts";
            const MAX_FILE_SIZE = 2000000000000000;

            let currentUser = null;
            let selectedUserId = null;
            let selectedUserName = null;
            let messagesListener = null;
            let isSignupMode = false;

            // Profanity filter
            const profanityList = [
                "damn","hell","crap","shit","fuck","ass","bitch","bastard","dick","piss","cock","pussy",
                "whore","slut","fag","nigger","cunt","twat","wanker","bollocks","arse","bugger"
            ];

            function filterProfanity(text) {
                let filtered = text;
                profanityList.forEach((word) => {
                    const regex = new RegExp(`\\b${word}\\b`, "gi");
                    filtered = filtered.replace(regex, "***");
                });
                return filtered;
            }

            // Cloudinary upload
            async function uploadToCloudinary(file) {
                if (file.size > MAX_FILE_SIZE) {
                    throw new Error(`Image must be smaller than ${Math.round(MAX_FILE_SIZE / 1024)}KB`);
                }
                const formData = new FormData();
                formData.append("file", file);
                formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
                const data = await response.json();
                return data.secure_url;
            }

            // UI elements
            const authSection = document.getElementById("authSection");
            const pendingSection = document.getElementById("pendingSection");
            const chatSection = document.getElementById("chatSection");
            const authError = document.getElementById("authError");
            const authSuccess = document.getElementById("authSuccess");
            const authTitle = document.getElementById("authTitle");
            const emailInput = document.getElementById("emailInput");
            const passwordInput = document.getElementById("passwordInput");
            const displayNameInput = document.getElementById("displayNameInput");
            const displayNameGroup = document.getElementById("displayNameGroup");
            const primaryBtn = document.getElementById("primaryBtn");
            const toggleAuth = document.getElementById("toggleAuth");
            const backToLoginBtn = document.getElementById("backToLoginBtn");
            const logoutBtn = document.getElementById("logoutBtn");
            const currentUserDisplay = document.getElementById("currentUserDisplay");
            const userAvatar = document.getElementById("userAvatar");
            const usersList = document.getElementById("usersList");
            const messagesContainer = document.getElementById("messagesContainer");
            const messageInput = document.getElementById("messageInput");
            const sendBtn = document.getElementById("sendBtn");
            const chatTitle = document.getElementById("chatTitle");
            const uploadImageBtn = document.getElementById("uploadImageBtn");
            const imageInput = document.getElementById("imageInput");
            const imageModal = document.getElementById("imageModal");
            const imageModalClose = document.getElementById("imageModalClose");
            const imageModalContent = document.getElementById("imageModalContent");

            // Image upload handlers
            uploadImageBtn.addEventListener("click", () => imageInput.click());
            imageInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) uploadAndSendImage(file);
                imageInput.value = "";
            });

            // Paste handling
            function handlePaste(e) {
                const items = e.clipboardData?.items;
                if (!items) return;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        e.preventDefault();
                        const file = items[i].getAsFile();
                        if (file) uploadAndSendImage(file);
                        break;
                    }
                }
            }
            messageInput.addEventListener("paste", handlePaste);

            // Image modal
            imageModalClose.addEventListener("click", () => imageModal.classList.remove("active"));
            imageModal.addEventListener("click", (e) => { if (e.target === imageModal) imageModal.classList.remove("active"); });
            function openImageModal(imageUrl) { imageModalContent.src = imageUrl; imageModal.classList.add("active"); }

            // Toggle login/signup UI
            toggleAuth.addEventListener("click", () => {
                isSignupMode = !isSignupMode;
                if (isSignupMode) {
                    authTitle.textContent = "Create Your Account";
                    primaryBtn.textContent = "Sign Up";
                    toggleAuth.textContent = "Already have an account? Log in";
                    displayNameGroup.classList.remove("hidden");
                } else {
                    authTitle.textContent = "Welcome Back";
                    primaryBtn.textContent = "Log In";
                    toggleAuth.textContent = "Need an account? Sign up";
                    displayNameGroup.classList.add("hidden");
                }
            });

            // Check user approval
            async function checkUserApproval(uid) {
                try {
                    const snap = await rtdbGet(rtdbRef(rtdb, `MessagesUsers/${uid}`));
                    if (!snap.exists()) return false;
                    const val = snap.val();
                    return !!val.approved;
                } catch (err) {
                    console.error("RTDB approval check error:", err);
                    return false;
                }
            }

            // Approval listener
            let approvalUnsub = null;
            function startApprovalListener(uid) {
                if (approvalUnsub) { try { approvalUnsub(); } catch (e) {} approvalUnsub = null; }
                const rRef = rtdbRef(rtdb, `MessagesUsers/${uid}`);
                approvalUnsub = rtdbOnValue(rRef, (snapshot) => {
                    if (!snapshot.exists()) return;
                    const data = snapshot.val();
                    if (data && data.approved === true) {
                        try { approvalUnsub(); } catch (e) {}
                        approvalUnsub = null;
                        window.location.reload();
                    }
                }, (err) => console.error("RTDB approval listener error:", err));
            }

            backToLoginBtn.addEventListener("click", async () => {
                if (approvalUnsub) { try { approvalUnsub(); } catch (e) {} approvalUnsub = null; }
                await signOut(auth);
                pendingSection.classList.add("hidden");
                authSection.classList.remove("hidden");
                isSignupMode = false;
                authTitle.textContent = "Welcome Back";
                primaryBtn.textContent = "Log In";
                toggleAuth.textContent = "Need an account? Sign up";
                displayNameGroup.classList.add("hidden");
            });

            function showError(message) {
                authError.textContent = message;
                authError.classList.remove("hidden");
                setTimeout(() => authError.classList.add("hidden"), 5000);
            }
            function showSuccess(message) {
                authSuccess.textContent = message;
                authSuccess.classList.remove("hidden");
                setTimeout(() => authSuccess.classList.add("hidden"), 3000);
            }

            // Upload & send image
            async function uploadAndSendImage(file) {
                if (!selectedUserId) { alert("Please select a user to send an image to"); return; }
                if (file.size > MAX_FILE_SIZE) { alert(`Image must be smaller than ${Math.round(MAX_FILE_SIZE / 1024)}KB.`); return; }
                try {
                    sendBtn.disabled = true;
                    sendBtn.textContent = "‚è≥";
                    const imageUrl = await uploadToCloudinary(file);
                    
                    // Create conversation key (sorted user IDs)
                    const conversationKey = [currentUser.uid, selectedUserId].sort().join('_');
                    
                    await rtdbPush(rtdbRef(rtdb, `MessagesConversations/${conversationKey}`), {
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName || currentUser.email,
                        receiverId: selectedUserId,
                        receiverName: selectedUserName,
                        imageUrl,
                        timestamp: rtdbServerTimestamp()
                    });
                    
                    sendBtn.disabled = false;
                    sendBtn.textContent = "‚û§";
                } catch (error) {
                    console.error("Error uploading image:", error);
                    alert("Failed to upload image: " + (error.message || error));
                    sendBtn.disabled = false;
                    sendBtn.textContent = "‚û§";
                }
            }

            // Auth handlers: LOGIN & SIGNUP
            primaryBtn.addEventListener("click", async () => {
                const email = (emailInput.value || "").trim();
                const password = passwordInput.value || "";

                if (!email || !password) {
                    showError("Please fill in email and password");
                    return;
                }

                if (isSignupMode) {
                    const displayName = (displayNameInput.value || "").trim();
                    if (!displayName) { showError("Please enter a display name"); return; }

                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        try { await updateProfile(user, { displayName }); } catch (e) { console.warn("updateProfile failed", e); }

                        await rtdbSet(rtdbRef(rtdb, `MessagesUsers/${user.uid}`), {
                            uid: user.uid,
                            displayName,
                            email,
                            createdAt: Date.now(),
                            lastSeen: Date.now(),
                            approved: false
                        });

                        showSuccess("Account created! Awaiting approval...");
                        emailInput.value = "";
                        passwordInput.value = "";
                        displayNameInput.value = "";
                    } catch (error) {
                        const msg = (error.code ? error.message.replace("Firebase: ", "") : String(error));
                        showError(msg);
                    }
                } else {
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        showError(error.message ? error.message.replace("Firebase: ", "") : String(error));
                    }
                }
            });

            // Logout
            logoutBtn.addEventListener("click", async () => { await signOut(auth); });

            // Auth state observer
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const approved = await checkUserApproval(user.uid);
                    if (!approved) {
                        authSection.classList.add("hidden");
                        chatSection.classList.add("hidden");
                        pendingSection.classList.remove("hidden");
                        startApprovalListener(user.uid);
                        return;
                    }

                    if (approvalUnsub) { try { approvalUnsub(); } catch (e) {} approvalUnsub = null; }

                    currentUser = user;
                    authSection.classList.add("hidden");
                    pendingSection.classList.add("hidden");
                    chatSection.classList.remove("hidden");

                    let displayName = user.displayName;
                    if (!displayName) {
                        try {
                            const userSnap = await rtdbGet(rtdbRef(rtdb, `MessagesUsers/${user.uid}`));
                            if (userSnap.exists()) displayName = userSnap.val().displayName;
                        } catch (err) { console.log("Could not fetch user:", err); }
                    }
                    currentUserDisplay.textContent = displayName || user.email;
                    userAvatar.textContent = (displayName || user.email)[0].toUpperCase();

                    try { await rtdbUpdate(rtdbRef(rtdb, `MessagesUsers/${user.uid}`), { lastSeen: Date.now() }); } catch (e) {}

                    loadUsers();
                } else {
                    currentUser = null;
                    selectedUserId = null;
                    selectedUserName = null;
                    authSection.classList.remove("hidden");
                    pendingSection.classList.add("hidden");
                    chatSection.classList.add("hidden");
                    if (approvalUnsub) { try { approvalUnsub(); } catch (e) {} approvalUnsub = null; }
                    if (messagesListener) { try { messagesListener(); } catch (e) {} messagesListener = null; }
                }
            });

            // Load users from Realtime DB
            async function loadUsers() {
                usersList.innerHTML = '<div class="loading">Loading users...</div>';
                try {
                    const usersRef = rtdbRef(rtdb, 'MessagesUsers');
                    rtdbOnValue(usersRef, (snapshot) => {
                        usersList.innerHTML = "";
                        const users = [];
                        
                        snapshot.forEach((childSnap) => {
                            const userData = childSnap.val();
                            if (childSnap.key !== currentUser.uid && userData.approved === true) {
                                users.push({
                                    id: childSnap.key,
                                    displayName: userData.displayName || userData.email || "User",
                                    email: userData.email
                                });
                            }
                        });
                        
                        if (users.length === 0) {
                            usersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No other approved users yet.</div>';
                            return;
                        }
                        
                        users.sort((a, b) => a.displayName.localeCompare(b.displayName));
                        users.forEach((user) => {
                            const userItem = document.createElement("div");
                            userItem.className = "user-item";
                            userItem.dataset.userId = user.id;
                            userItem.innerHTML = `
                                <div class="user-avatar">${user.displayName[0].toUpperCase()}</div>
                                <div class="user-info">
                                    <div class="user-name">${user.displayName}</div>
                                    <div class="user-status">AllForOne Member</div>
                                </div>
                            `;
                            userItem.addEventListener("click", () => selectUser(user));
                            usersList.appendChild(userItem);
                        });
                    }, (error) => {
                        console.error("Error loading users:", error);
                        usersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Error loading users. Please refresh.</div>';
                    });
                } catch (error) {
                    console.error("Error setting up users listener:", error);
                    usersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Error loading users. Please refresh.</div>';
                }
            }

            function selectUser(user) {
                selectedUserId = user.id;
                selectedUserName = user.displayName;
                chatTitle.textContent = `Chat with ${user.displayName}`;
                document.querySelectorAll(".user-item").forEach((item) => item.classList.remove("active"));
                const selectedItem = document.querySelector(`[data-user-id="${user.id}"]`);
                if (selectedItem) selectedItem.classList.add("active");
                loadMessages();
            }

            // Load messages from Realtime DB
            function loadMessages() {
                if (messagesListener) messagesListener();
                messagesContainer.innerHTML = "";
                
                // Create conversation key (sorted user IDs)
                const conversationKey = [currentUser.uid, selectedUserId].sort().join('_');
                const messagesRef = rtdbRef(rtdb, `MessagesConversations/${conversationKey}`);
                
                messagesListener = rtdbOnValue(messagesRef, (snapshot) => {
                    messagesContainer.innerHTML = "";
                    let hasMessages = false;
                    
                    const messages = [];
                    snapshot.forEach((childSnap) => {
                        messages.push({
                            id: childSnap.key,
                            ...childSnap.val()
                        });
                    });
                    
                    // Sort by timestamp
                    messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    
                    messages.forEach((msg) => {
                        displayMessage(msg);
                        hasMessages = true;
                    });
                    
                    if (!hasMessages) {
                        messagesContainer.innerHTML = `
                            <div class="empty-state">
                                <h3>üí¨ Start a conversation</h3>
                                <p>Send the first message to ${selectedUserName}</p>
                            </div>
                        `;
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            }

            function displayMessage(msg) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${msg.senderId === currentUser.uid ? "sent" : "received"}`;
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) : "Now";
                let content = "";
                if (msg.imageUrl) content = `<img src="${msg.imageUrl}" class="message-image" alt="Shared image">`;
                else content = `<div>${msg.text}</div>`;
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        ${content}
                        <div class="message-meta">${time}</div>
                    </div>
                `;
                if (msg.imageUrl) {
                    const img = messageDiv.querySelector(".message-image");
                    img.addEventListener("click", () => openImageModal(msg.imageUrl));
                }
                messagesContainer.appendChild(messageDiv);
            }

            async function sendMessage() {
                if (!selectedUserId || !messageInput.value.trim()) return;
                const text = filterProfanity(messageInput.value.trim());
                try {
                    sendBtn.disabled = true;
                    
                    // Create conversation key (sorted user IDs)
                    const conversationKey = [currentUser.uid, selectedUserId].sort().join('_');
                    
                    await rtdbPush(rtdbRef(rtdb, `MessagesConversations/${conversationKey}`), {
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName || currentUser.email,
                        receiverId: selectedUserId,
                        receiverName: selectedUserName,
                        text,
                        timestamp: rtdbServerTimestamp()
                    });
                    
                    messageInput.value = "";
                    sendBtn.disabled = false;
                } catch (error) {
                    console.error("Error sending message:", error);
                    alert("Failed to send message. Please try again.");
                    sendBtn.disabled = false;
                }
            }

            sendBtn.addEventListener("click", sendMessage);
            messageInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });
        </script>
    </body>
</html>
