<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AllForOne Messages</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f9f9f9;
      color: #1C1C1C;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 95%;
      max-width: 1200px;
      height: 90vh;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: linear-gradient(135deg, #1e90ff 0%, #0B5394 100%);
      padding: 20px 30px;
      color: white;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .auth-section, .pending-section {
      padding: 30px;
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .auth-section h2, .pending-section h2 {
      color: #1e90ff;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .pending-section p {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .auth-form {
      max-width: 400px;
      margin: 0 auto;
      width: 100%;
    }

    .input-group {
      margin-bottom: 15px;
    }

    input {
      width: 100%;
      padding: 14px 18px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
      background: #f9f9f9;
    }

    input:focus {
      outline: none;
      border-color: #1e90ff;
      background: white;
    }

    button {
      width: 100%;
      padding: 14px;
      background: #1e90ff;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 10px;
    }

    button:hover {
      background: #0B5394;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .secondary-btn {
      background: #4A86E8;
    }

    .secondary-btn:hover {
      background: #0B5394;
    }

    .logout-btn {
      background: #ef4444;
      width: auto;
      padding: 10px 20px;
      font-size: 14px;
      margin: 0;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    .toggle-link {
      color: #1e90ff;
      cursor: pointer;
      text-decoration: underline;
      margin-top: 15px;
      display: inline-block;
    }

    .toggle-link:hover {
      color: #0B5394;
    }

    .chat-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .users-list {
      width: 300px;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      background: #f9f9f9;
    }

    .user-item {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-item:hover {
      background: white;
    }

    .user-item.active {
      background: #e3f2fd;
      border-left: 3px solid #1e90ff;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4A86E8, #1e90ff);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-weight: 500;
      color: #1C1C1C;
      margin-bottom: 2px;
    }

    .user-status {
      font-size: 12px;
      color: #666;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 20px 30px;
      border-bottom: 1px solid #e0e0e0;
      background: white;
    }

    .chat-header h3 {
      color: #1e90ff;
      font-size: 20px;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 30px;
      background: #f9f9f9;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.sent {
      flex-direction: row-reverse;
    }

    .message-bubble {
      max-width: 60%;
      padding: 12px 16px;
      border-radius: 16px;
      word-wrap: break-word;
    }

    .message.received .message-bubble {
      background: white;
      border: 1px solid #e0e0e0;
      color: #1C1C1C;
    }

    .message.sent .message-bubble {
      background: #1e90ff;
      color: white;
    }

    .message-meta {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .message-input-area {
      padding: 20px 30px;
      border-top: 1px solid #e0e0e0;
      background: white;
      display: flex;
      gap: 12px;
    }

    .message-input {
      flex: 1;
      padding: 14px 18px;
      border: 1px solid #e0e0e0;
      border-radius: 24px;
      font-size: 15px;
      resize: none;
      font-family: inherit;
      background: #f9f9f9;
    }

    .message-input:focus {
      outline: none;
      border-color: #1e90ff;
      background: white;
    }

    .send-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #1e90ff;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .send-btn:hover {
      background: #0B5394;
      transform: scale(1.05);
    }

    .error {
      background: #fff1f2;
      color: #ef4444;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      border: 1px solid #fee2e2;
    }

    .success {
      background: #ecfdf5;
      color: #047857;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      border: 1px solid #d1fae5;
    }

    .hidden {
      display: none !important;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h3 {
      color: #1e90ff;
      margin-bottom: 10px;
      font-size: 20px;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f9f9f9;
    }

    ::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .top-bar {
      padding: 15px 30px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
    }

    .user-info-display {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .top-bar-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4A86E8, #1e90ff);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>AllForOne Messages</h1>
      <p>Minecraft Education Edition Server - 24/7 Community</p>
    </div>

    <!-- Auth Section -->
    <div id="authSection" class="auth-section">
      <h2 id="authTitle">Welcome Back</h2>
      <div id="authError" class="error hidden"></div>
      <div id="authSuccess" class="success hidden"></div>
      <div class="auth-form">
        <div class="input-group">
          <input type="email" id="emailInput" placeholder="Email Address">
        </div>
        <div class="input-group">
          <input type="password" id="passwordInput" placeholder="Password">
        </div>
        <div class="input-group hidden" id="displayNameGroup">
          <input type="text" id="displayNameInput" placeholder="Display Name">
        </div>
        <button id="primaryBtn">Log In</button>
        <div class="toggle-link" id="toggleAuth">Need an account? Sign up</div>
      </div>
    </div>

    <!-- Pending Approval Section -->
    <div id="pendingSection" class="pending-section hidden">
      <h2>‚è≥ Awaiting Approval</h2>
      <p>Your account has been created successfully!</p>
      <p>Please wait for an administrator to approve your account before you can access the messaging system.</p>
      <p style="font-size: 14px; color: #047857; margin-top: 20px; font-weight: 500;">‚úì This page will automatically refresh when you're approved</p>
      <p style="font-size: 14px; color: #999; margin-top: 10px;">You can also click "Back to Login" to check manually</p>
      <button id="backToLoginBtn" class="secondary-btn" style="max-width: 300px; margin: 20px auto 0;">Back to Login</button>
    </div>

    <!-- Chat Section -->
    <div id="chatSection" class="hidden">
      <div class="top-bar">
        <div class="user-info-display">
          <div class="top-bar-avatar" id="userAvatar"></div>
          <div>
            <div style="color: #1e90ff; font-weight: 500; font-size: 14px;">Logged in as</div>
            <div style="font-weight: 500;" id="currentUserDisplay"></div>
          </div>
        </div>
        <button class="logout-btn" id="logoutBtn">Log Out</button>
      </div>
      <div class="chat-container">
        <div class="users-list" id="usersList">
          <div class="loading">Loading users...</div>
        </div>
        <div class="chat-area">
          <div class="chat-header">
            <h3 id="chatTitle">Select a user to start messaging</h3>
          </div>
          <div class="messages-container" id="messagesContainer">
            <div class="empty-state">
              <h3>üëã Welcome!</h3>
              <p>Select a user from the list to start chatting</p>
            </div>
          </div>
          <div class="message-input-area">
            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn">‚û§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged, 
      updateProfile, 
      setPersistence, 
      browserLocalPersistence 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      query, 
      orderBy, 
      onSnapshot, 
      serverTimestamp, 
      setDoc, 
      doc, 
      getDoc 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDzQlAqhCeytCLEYafboYGpFu6pY3Kv9WE",
      authDomain: "allforonemedia-9a7d8.firebaseapp.com",
      databaseURL: "https://allforonemedia-9a7d8-default-rtdb.firebaseio.com",
      projectId: "allforonemedia-9a7d8",
      storageBucket: "allforonemedia-9a7d8.firebasestorage.app",
      messagingSenderId: "892787060584",
      appId: "1:892787060584:web:e65609062592f9ba96f0dd",
      measurementId: "G-JSXKLMBRLC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    setPersistence(auth, browserLocalPersistence);

    let currentUser = null;
    let selectedUserId = null;
    let selectedUserName = null;
    let unsubscribeMessages = null;
    let isSignupMode = false;

    // Profanity filter
    const profanityList = [
      'damn', 'hell', 'crap', 'shit', 'fuck', 'ass', 'bitch', 'bastard',
      'dick', 'piss', 'cock', 'pussy', 'whore', 'slut', 'fag', 'nigger',
      'cunt', 'twat', 'wanker', 'bollocks', 'arse', 'bugger'
    ];

    function filterProfanity(text) {
      let filtered = text;
      profanityList.forEach(word => {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        filtered = filtered.replace(regex, '***');
      });
      return filtered;
    }

    // Check if user is approved
    async function checkUserApproval(uid) {
      try {
        const userDoc = await getDoc(doc(db, "MessagesUsers", uid));
        if (!userDoc.exists()) {
          return false;
        }
        return userDoc.data().approved === true;
      } catch (error) {
        console.error("Error checking approval:", error);
        return false;
      }
    }

    // UI Elements
    const authSection = document.getElementById('authSection');
    const pendingSection = document.getElementById('pendingSection');
    const chatSection = document.getElementById('chatSection');
    const authError = document.getElementById('authError');
    const authSuccess = document.getElementById('authSuccess');
    const authTitle = document.getElementById('authTitle');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const displayNameInput = document.getElementById('displayNameInput');
    const displayNameGroup = document.getElementById('displayNameGroup');
    const primaryBtn = document.getElementById('primaryBtn');
    const toggleAuth = document.getElementById('toggleAuth');
    const backToLoginBtn = document.getElementById('backToLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUserDisplay = document.getElementById('currentUserDisplay');
    const userAvatar = document.getElementById('userAvatar');
    const usersList = document.getElementById('usersList');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatTitle = document.getElementById('chatTitle');

    // Toggle between login and signup
    toggleAuth.addEventListener('click', () => {
      isSignupMode = !isSignupMode;
      if (isSignupMode) {
        authTitle.textContent = 'Create Your Account';
        primaryBtn.textContent = 'Sign Up';
        toggleAuth.textContent = 'Already have an account? Log in';
        displayNameGroup.classList.remove('hidden');
      } else {
        authTitle.textContent = 'Welcome Back';
        primaryBtn.textContent = 'Log In';
        toggleAuth.textContent = 'Need an account? Sign up';
        displayNameGroup.classList.add('hidden');
      }
    });

    // Real-time approval listener
    let approvalListener = null;

    function startApprovalListener(uid) {
      if (approvalListener) {
        approvalListener();
      }

      const userDocRef = doc(db, 'MessagesUsers', uid);
      approvalListener = onSnapshot(userDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const userData = docSnap.data();
          if (userData.approved === true) {
            // User was just approved! Reload to show the chat
            window.location.reload();
          }
        }
      });
    }

    backToLoginBtn.addEventListener('click', async () => {
      if (approvalListener) {
        approvalListener();
        approvalListener = null;
      }
      await signOut(auth);
      pendingSection.classList.add('hidden');
      authSection.classList.remove('hidden');
      isSignupMode = false;
      authTitle.textContent = 'Welcome Back';
      primaryBtn.textContent = 'Log In';
      toggleAuth.textContent = 'Need an account? Sign up';
      displayNameGroup.classList.add('hidden');
    });

    function showError(message) {
      authError.textContent = message;
      authError.classList.remove('hidden');
      setTimeout(() => authError.classList.add('hidden'), 5000);
    }

    function showSuccess(message) {
      authSuccess.textContent = message;
      authSuccess.classList.remove('hidden');
      setTimeout(() => authSuccess.classList.add('hidden'), 3000);
    }

    // Auth handlers
    primaryBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        showError('Please fill in email and password');
        return;
      }

      if (isSignupMode) {
        const displayName = displayNameInput.value.trim();
        if (!displayName) {
          showError('Please enter a display name');
          return;
        }

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          
          await updateProfile(user, { displayName });
          
          await setDoc(doc(db, 'MessagesUsers', user.uid), {
            uid: user.uid,
            displayName: displayName,
            email: email,
            createdAt: serverTimestamp(),
            lastSeen: serverTimestamp(),
            approved: false
          });

          showSuccess('Account created! Awaiting approval...');
          
          emailInput.value = '';
          passwordInput.value = '';
          displayNameInput.value = '';
        } catch (error) {
          showError(error.message.replace('Firebase: ', ''));
        }
      } else {
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
          showError(error.message.replace('Firebase: ', ''));
        }
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const isApproved = await checkUserApproval(user.uid);

        if (!isApproved) {
          authSection.classList.add('hidden');
          chatSection.classList.add('hidden');
          pendingSection.classList.remove('hidden');
          
          // Start listening for approval
          startApprovalListener(user.uid);
          return;
        }

        // Stop approval listener if it's running
        if (approvalListener) {
          approvalListener();
          approvalListener = null;
        }

        currentUser = user;
        authSection.classList.add('hidden');
        pendingSection.classList.add('hidden');
        chatSection.classList.remove('hidden');
        
        let displayName = user.displayName;
        if (!displayName) {
          try {
            const userDoc = await getDoc(doc(db, 'MessagesUsers', user.uid));
            if (userDoc.exists()) {
              displayName = userDoc.data().displayName;
            }
          } catch (error) {
            console.log('Could not fetch user data:', error);
          }
        }
        
        currentUserDisplay.textContent = displayName || user.email;
        userAvatar.textContent = (displayName || user.email)[0].toUpperCase();
        
        try {
          await setDoc(doc(db, 'MessagesUsers', user.uid), {
            lastSeen: serverTimestamp()
          }, { merge: true });
        } catch (error) {
          console.log('Could not update lastSeen:', error);
        }

        loadUsers();
      } else {
        currentUser = null;
        selectedUserId = null;
        selectedUserName = null;
        authSection.classList.remove('hidden');
        pendingSection.classList.add('hidden');
        chatSection.classList.add('hidden');
        
        // Stop approval listener
        if (approvalListener) {
          approvalListener();
          approvalListener = null;
        }
        
        if (unsubscribeMessages) unsubscribeMessages();
      }
    });

    // Load users from Firestore
    async function loadUsers() {
      usersList.innerHTML = '<div class="loading">Loading users...</div>';
      
      try {
        const usersQuery = query(collection(db, 'MessagesUsers'));
        
        onSnapshot(usersQuery, (snapshot) => {
          usersList.innerHTML = '';
          
          const users = [];
          snapshot.forEach(doc => {
            const userData = doc.data();
            if (doc.id !== currentUser.uid && userData.approved === true) {
              users.push({
                id: doc.id,
                displayName: userData.displayName || userData.email || 'User',
                email: userData.email
              });
            }
          });

          if (users.length === 0) {
            usersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No other approved users yet.</div>';
            return;
          }

          users.sort((a, b) => a.displayName.localeCompare(b.displayName));

          users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.dataset.userId = user.id;
            userItem.innerHTML = `
              <div class="user-avatar">${user.displayName[0].toUpperCase()}</div>
              <div class="user-info">
                <div class="user-name">${user.displayName}</div>
                <div class="user-status">AllForOne Member</div>
              </div>
            `;
            userItem.addEventListener('click', () => selectUser(user));
            usersList.appendChild(userItem);
          });
        }, (error) => {
          console.error('Error loading users:', error);
          usersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Error loading users. Please refresh.</div>';
        });
      } catch (error) {
        console.error('Error setting up users listener:', error);
        usersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Error loading users. Please refresh.</div>';
      }
    }

    function selectUser(user) {
      selectedUserId = user.id;
      selectedUserName = user.displayName;
      chatTitle.textContent = `Chat with ${user.displayName}`;
      
      document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const selectedItem = document.querySelector(`[data-user-id="${user.id}"]`);
      if (selectedItem) {
        selectedItem.classList.add('active');
      }
      
      loadMessages();
    }

    function loadMessages() {
      if (unsubscribeMessages) unsubscribeMessages();
      
      messagesContainer.innerHTML = '';
      
      const q = query(
        collection(db, 'MessagesConversations'),
        orderBy('timestamp', 'asc')
      );

      unsubscribeMessages = onSnapshot(q, (snapshot) => {
        messagesContainer.innerHTML = '';
        
        let hasMessages = false;
        snapshot.forEach(doc => {
          const msg = doc.data();
          if (
            (msg.senderId === currentUser.uid && msg.receiverId === selectedUserId) ||
            (msg.senderId === selectedUserId && msg.receiverId === currentUser.uid)
          ) {
            displayMessage(msg);
            hasMessages = true;
          }
        });

        if (!hasMessages) {
          messagesContainer.innerHTML = `
            <div class="empty-state">
              <h3>üí¨ Start a conversation</h3>
              <p>Send the first message to ${selectedUserName}</p>
            </div>
          `;
        }

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }

    function displayMessage(msg) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
      
      const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Now';
      
      messageDiv.innerHTML = `
        <div class="message-bubble">
          <div>${msg.text}</div>
          <div class="message-meta">${time}</div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
    }

    async function sendMessage() {
      if (!selectedUserId || !messageInput.value.trim()) return;

      const text = filterProfanity(messageInput.value.trim());
      
      try {
        const senderName = currentUser.displayName || (await getDoc(doc(db, 'MessagesUsers', currentUser.uid))).data()?.displayName || currentUser.email;
        
        await addDoc(collection(db, 'MessagesConversations'), {
          senderId: currentUser.uid,
          senderName: senderName,
          receiverId: selectedUserId,
          receiverName: selectedUserName,
          text: text,
          timestamp: serverTimestamp()
        });

        messageInput.value = '';
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
