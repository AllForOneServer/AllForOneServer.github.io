<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Private Posting Page</title>
        <link rel="stylesheet" href="style.css" />
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    </head>
    <body>
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>Private Community</h1>
                <p>Share and connect with approved members</p>
            </div>

            <!-- Top Bar (shown when logged in) -->
            <div class="top-bar hidden" id="topBar">
                <div class="user-info-display">
                    <div class="top-bar-avatar" id="topBarAvatar"></div>
                    <div>
                        <div id="topBarName" style="font-weight: 600"></div>
                        <div id="topBarRole" style="font-size: 12px; color: #666"></div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <!-- Login Form -->
            <div class="auth-section centered" id="loginForm">
                <div class="auth-card">
                    <h2>Welcome Back</h2>
                    <div class="auth-form">
                        <div class="input-group">
                            <input type="email" id="email" placeholder="Email" />
                        </div>
                        <div class="input-group">
                            <input type="password" id="password" placeholder="Password" />
                        </div>
                        <button onclick="login()">Login</button>
                        <p style="margin-top: 20px">Don't have an account?</p>
                        <button class="secondary-btn" onclick="showSignup()">Sign Up</button>
                    </div>
                </div>
            </div>

            <!-- Signup Form -->
            <div class="auth-section centered hidden" id="signupForm">
                <div class="auth-card">
                    <h2>Create Account</h2>
                    <div class="auth-form">
                        <div class="input-group">
                            <input type="text" id="signupName" placeholder="Full Name" />
                        </div>
                        <div class="input-group">
                            <input type="email" id="signupEmail" placeholder="Email" />
                        </div>
                        <div class="input-group">
                            <input type="password" id="signupPassword" placeholder="Password" />
                        </div>
                        <button onclick="signup()">Sign Up</button>
                        <p style="margin-top: 20px">Already have an account?</p>
                        <button class="secondary-btn" onclick="showLogin()">Login</button>
                    </div>
                </div>
            </div>

            <!-- Admin notice -->
            <div class="pending-approval centered hidden" id="adminNotice">
                <h2>‚è≥ Pending Approval</h2>
                <p>Your account is awaiting admin approval. You'll be able to access the community once approved.</p>
                <button class="secondary-btn" style="margin-top: 20px" onclick="logout()">Logout</button>
            </div>

            <!-- Main Content -->
            <div class="container centered hidden" id="mainContent">
                <!-- Post Form -->
                <div class="post" style="margin-bottom: 30px">
                    <h3 style="margin-bottom: 15px" id="postFormTitle">Create Post</h3>
                    <div class="input-group">
                        <input type="text" id="postHeading" placeholder="Post heading (optional)" />
                    </div>
                    <div class="input-group">
                        <textarea id="postContent" placeholder="What's on your mind?" rows="4"></textarea>
                    </div>
                    <div class="input-group">
                        <input type="file" id="postImage" accept="image/*" />
                    </div>
                    <div style="display: flex; gap: 10px">
                        <button onclick="submitPost()" id="submitPostBtn">Submit Post</button>
                        <button class="secondary-btn hidden" id="cancelAnnouncementBtn" onclick="cancelAnnouncement()">
                            Cancel
                        </button>
                    </div>
                    <button
                        class="secondary-btn hidden"
                        id="makeAnnouncementBtn"
                        onclick="makeAnnouncement()"
                        style="margin-top: 10px">
                        üì¢ Make Announcement
                    </button>
                </div>

                <!-- Admin Panel -->
                <div
                    class="post hidden"
                    id="adminPanel"
                    style="
                        margin-bottom: 30px;
                        background: linear-gradient(135deg, #fef3c7, #fff9c4);
                        border: 2px solid #facc15;
                    ">
                    <h3 style="margin-bottom: 15px">üëë Admin Panel</h3>
                    <p style="margin-bottom: 15px">Manage user approvals and permissions</p>
                    <div id="pendingUsers"></div>
                </div>

                <!-- Posts List -->
                <div id="postsList"></div>
            </div>
        </div>

        <script>
            // Firebase config
            const firebaseConfig = {
                apiKey: "AIzaSyDzQlAqhCeytCLEYafboYGpFu6pY3Kv9WE",
                authDomain: "allforonemedia-9a7d8.firebaseapp.com",
                projectId: "allforonemedia-9a7d8",
                storageBucket: "allforonemedia-9a7d8.firebasestorage.app",
                messagingSenderId: "892787060584",
                appId: "1:892787060584:web:e65609062592f9ba96f0dd",
                measurementId: "G-JSXKLMBRLC"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            const CLOUDINARY_CLOUD_NAME = "dgrmpcha9";
            const CLOUDINARY_UPLOAD_PRESET = "AllForOne Posts";

            let currentUser = null;
            let isAnnouncementMode = false;

            // Check for existing session on page load
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in, check if approved
                    const userDoc = await db.collection("users").doc(user.uid).get();
                    if (userDoc.exists && userDoc.data().approved) {
                        currentUser = { uid: user.uid, ...userDoc.data() };
                        showMainContent();
                    } else if (userDoc.exists) {
                        // User exists but not approved
                        document.getElementById("loginForm").classList.add("hidden");
                        document.getElementById("signupForm").classList.add("hidden");
                        document.getElementById("adminNotice").classList.remove("hidden");
                    } else {
                        // User doesn't exist in database (shouldn't happen)
                        document.getElementById("loginForm").classList.remove("hidden");
                    }
                } else {
                    // No user signed in, show login
                    document.getElementById("loginForm").classList.remove("hidden");
                }
            });

            function showSignup() {
                document.getElementById("loginForm").classList.add("hidden");
                document.getElementById("signupForm").classList.remove("hidden");
            }

            function showLogin() {
                document.getElementById("signupForm").classList.add("hidden");
                document.getElementById("loginForm").classList.remove("hidden");
            }

            // Signup function
            async function signup() {
                const name = document.getElementById("signupName").value;
                const email = document.getElementById("signupEmail").value;
                const password = document.getElementById("signupPassword").value;

                if (!name || !email || !password) {
                    alert("Please fill in all fields");
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    await db.collection("users").doc(user.uid).set({
                        name: name,
                        email: email,
                        approved: false,
                        isAdmin: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("Signup successful! Await admin approval.");
                    showLogin();
                } catch (error) {
                    alert(error.message);
                }
            }

            // Login function
            async function login() {
                const email = document.getElementById("email").value;
                const password = document.getElementById("password").value;
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    const userDoc = await db.collection("users").doc(user.uid).get();

                    if (userDoc.exists && userDoc.data().approved) {
                        currentUser = { uid: user.uid, ...userDoc.data() };
                        showMainContent();
                    } else {
                        document.getElementById("loginForm").classList.add("hidden");
                        document.getElementById("adminNotice").classList.remove("hidden");
                    }
                } catch (error) {
                    alert(error.message);
                }
            }

            function logout() {
                auth.signOut();
                location.reload();
            }

            function showMainContent() {
                document.getElementById("loginForm").classList.add("hidden");
                document.getElementById("signupForm").classList.add("hidden");
                document.getElementById("adminNotice").classList.add("hidden");
                document.getElementById("topBar").classList.remove("hidden");
                document.getElementById("mainContent").classList.remove("hidden");

                // Update top bar
                document.getElementById("topBarAvatar").textContent = currentUser.name.charAt(0).toUpperCase();
                document.getElementById("topBarName").textContent = currentUser.name;
                document.getElementById("topBarRole").textContent = currentUser.isAdmin ? "üëë Admin" : "Member";

                // Show admin features
                if (currentUser.isAdmin) {
                    document.getElementById("makeAnnouncementBtn").classList.remove("hidden");
                    document.getElementById("adminPanel").classList.remove("hidden");
                    loadPendingUsers();
                }

                loadPosts();
            }

            // Admin panel - load pending users
            async function loadPendingUsers() {
                const pendingUsersDiv = document.getElementById("pendingUsers");
                const usersSnapshot = await db.collection("users").get();

                let html = "";
                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    html += `
        <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${user.name}</strong> (${user.email})
            <div style="font-size: 12px; color: #666;">
              Status: ${user.approved ? "‚úÖ Approved" : "‚è≥ Pending"} | 
              Role: ${user.isAdmin ? "üëë Admin" : "üë§ User"}
            </div>
          </div>
          <div style="display: flex; gap: 10px;">
            ${!user.approved ? `<button class="btn-secondary" style="width: auto; padding: 8px 15px; font-size: 14px;" onclick="approveUser('${doc.id}')">Approve</button>` : ""}
            ${!user.isAdmin ? `<button class="btn-secondary" style="width: auto; padding: 8px 15px; font-size: 14px;" onclick="makeAdmin('${doc.id}')">Make Admin</button>` : ""}
            ${user.isAdmin && doc.id !== currentUser.uid ? `<button class="btn-danger" style="padding: 8px 15px; font-size: 14px;" onclick="removeAdmin('${doc.id}')">Remove Admin</button>` : ""}
          </div>
        </div>
      `;
                });

                pendingUsersDiv.innerHTML = html || '<p style="text-align: center; color: #666;">No pending users</p>';
            }

            async function approveUser(uid) {
                await db.collection("users").doc(uid).update({ approved: true });
                loadPendingUsers();
                alert("User approved!");
            }

            async function makeAdmin(uid) {
                if (confirm("Are you sure you want to make this user an admin?")) {
                    await db.collection("users").doc(uid).update({ isAdmin: true });
                    loadPendingUsers();
                    alert("User is now an admin!");
                }
            }

            async function removeAdmin(uid) {
                if (confirm("Are you sure you want to remove admin privileges?")) {
                    await db.collection("users").doc(uid).update({ isAdmin: false });
                    loadPendingUsers();
                    alert("Admin privileges removed!");
                }
            }

            function makeAnnouncement() {
                isAnnouncementMode = true;
                document.getElementById("postFormTitle").textContent = "üì¢ Create Announcement";
                document.getElementById("makeAnnouncementBtn").classList.add("hidden");
                document.getElementById("cancelAnnouncementBtn").classList.remove("hidden");
            }

            function cancelAnnouncement() {
                isAnnouncementMode = false;
                document.getElementById("postFormTitle").textContent = "Create Post";
                document.getElementById("makeAnnouncementBtn").classList.remove("hidden");
                document.getElementById("cancelAnnouncementBtn").classList.add("hidden");
            }

            // Submit post
            async function submitPost() {
                const heading = document.getElementById("postHeading").value;
                const content = document.getElementById("postContent").value;
                const imageFile = document.getElementById("postImage").files[0];
                let imageUrl = "";

                if (!content) {
                    alert("Please write something!");
                    return;
                }

                if (imageFile) {
                    const formData = new FormData();
                    formData.append("file", imageFile);
                    formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

                    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
                        method: "POST",
                        body: formData
                    });
                    const data = await response.json();
                    imageUrl = data.secure_url;
                }

                await db.collection("posts").add({
                    heading: heading,
                    content: content,
                    imageUrl: imageUrl,
                    isAnnouncement: isAnnouncementMode,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    uid: currentUser.uid,
                    userName: currentUser.name,
                    likes: [],
                    dislikes: []
                });

                document.getElementById("postHeading").value = "";
                document.getElementById("postContent").value = "";
                document.getElementById("postImage").value = "";
                if (isAnnouncementMode) cancelAnnouncement();
            }

            // Load posts
            function loadPosts() {
                const postsList = document.getElementById("postsList");
                db.collection("posts")
                    .orderBy("timestamp", "desc")
                    .onSnapshot((snapshot) => {
                        postsList.innerHTML = "";
                        snapshot.forEach((doc) => {
                            const post = doc.data();
                            const postId = doc.id;
                            const likeCount = post.likes ? post.likes.length : 0;
                            const dislikeCount = post.dislikes ? post.dislikes.length : 0;
                            const hasLiked = post.likes && post.likes.includes(currentUser.uid);
                            const hasDisliked = post.dislikes && post.dislikes.includes(currentUser.uid);

                            const div = document.createElement("div");
                            div.className = post.isAnnouncement ? "post announcement" : "post";
                            div.style.marginBottom = "20px";

                            div.innerHTML = `
          ${post.isAnnouncement ? '<div style="font-weight: 600; color: #ca8a04; margin-bottom: 10px;">üì¢ ANNOUNCEMENT</div>' : ""}
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <div style="display: flex; gap: 12px; align-items: center;">
              <div class="post-avatar" style="width: 40px; height: 40px; font-size: 18px;">
                ${post.userName.charAt(0).toUpperCase()}
              </div>
              <div>
                <div style="font-weight: 600;">${post.userName}</div>
                <div style="font-size: 12px; color: #666;">${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : "Just now"}</div>
              </div>
            </div>
            ${currentUser.isAdmin || post.uid === currentUser.uid ? `<button class="btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deletePost('${postId}')">Delete</button>` : ""}
          </div>
          ${post.heading ? `<h3 style="margin-bottom: 10px;">${post.heading}</h3>` : ""}
          <div class="post-content" style="margin-bottom: 15px;">${post.content}</div>
          ${post.imageUrl ? `<img src="${post.imageUrl}" style="max-width: 100%; border-radius: 12px; margin-bottom: 15px;">` : ""}
          <div style="display: flex; gap: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
            <button class="secondary-btn" style="width: auto; padding: 8px 15px; font-size: 14px; ${hasLiked ? "background: #10b981;" : ""}" onclick="toggleLike('${postId}')">
              üëç ${likeCount}
            </button>
            <button class="secondary-btn" style="width: auto; padding: 8px 15px; font-size: 14px; ${hasDisliked ? "background: #ef4444;" : ""}" onclick="toggleDislike('${postId}')">
              üëé ${dislikeCount}
            </button>
            <button class="secondary-btn" style="width: auto; padding: 8px 15px; font-size: 14px;" onclick="toggleComments('${postId}')">
              üí¨ <span id="comment-count-${postId}">0</span>
            </button>
          </div>
          <div id="comments-${postId}" class="hidden" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
              <input type="text" id="comment-input-${postId}" placeholder="Write a comment..." style="flex: 1; margin: 0;" />
              <button class="secondary-btn" style="width: auto; padding: 10px 20px; margin: 0;" onclick="addComment('${postId}')">Post</button>
            </div>
            <div id="comments-list-${postId}"></div>
          </div>
        `;
                            postsList.appendChild(div);

                            loadComments(postId);
                        });
                    });
            }

            async function deletePost(postId) {
                if (confirm("Are you sure you want to delete this post?")) {
                    await db.collection("posts").doc(postId).delete();
                    // Delete all comments for this post
                    const commentsSnapshot = await db.collection("posts").doc(postId).collection("comments").get();
                    commentsSnapshot.forEach(async (doc) => {
                        await doc.ref.delete();
                    });
                }
            }

            async function toggleLike(postId) {
                const postRef = db.collection("posts").doc(postId);
                const postDoc = await postRef.get();
                const post = postDoc.data();

                let likes = post.likes || [];
                let dislikes = post.dislikes || [];

                if (likes.includes(currentUser.uid)) {
                    likes = likes.filter((uid) => uid !== currentUser.uid);
                } else {
                    likes.push(currentUser.uid);
                    dislikes = dislikes.filter((uid) => uid !== currentUser.uid);
                }

                await postRef.update({ likes, dislikes });
            }

            async function toggleDislike(postId) {
                const postRef = db.collection("posts").doc(postId);
                const postDoc = await postRef.get();
                const post = postDoc.data();

                let likes = post.likes || [];
                let dislikes = post.dislikes || [];

                if (dislikes.includes(currentUser.uid)) {
                    dislikes = dislikes.filter((uid) => uid !== currentUser.uid);
                } else {
                    dislikes.push(currentUser.uid);
                    likes = likes.filter((uid) => uid !== currentUser.uid);
                }

                await postRef.update({ likes, dislikes });
            }

            function toggleComments(postId) {
                const commentsDiv = document.getElementById(`comments-${postId}`);
                commentsDiv.classList.toggle("hidden");
            }

            async function addComment(postId) {
                const input = document.getElementById(`comment-input-${postId}`);
                const text = input.value.trim();

                if (!text) return;

                await db.collection("posts").doc(postId).collection("comments").add({
                    text: text,
                    uid: currentUser.uid,
                    userName: currentUser.name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                input.value = "";
            }

            function loadComments(postId) {
                db.collection("posts")
                    .doc(postId)
                    .collection("comments")
                    .orderBy("timestamp", "asc")
                    .onSnapshot((snapshot) => {
                        const commentsListDiv = document.getElementById(`comments-list-${postId}`);
                        const commentCountSpan = document.getElementById(`comment-count-${postId}`);

                        if (!commentsListDiv) return;

                        // Update comment count
                        if (commentCountSpan) {
                            commentCountSpan.textContent = snapshot.size;
                        }

                        commentsListDiv.innerHTML = "";
                        snapshot.forEach((doc) => {
                            const comment = doc.data();
                            const commentDiv = document.createElement("div");
                            commentDiv.style.cssText =
                                "background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 10px;";
                            commentDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="display: flex; gap: 10px;">
              <div class="comment-avatar" style="width: 32px; height: 32px; font-size: 14px;">
                ${comment.userName.charAt(0).toUpperCase()}
              </div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 14px;">${comment.userName}</div>
                <div style="font-size: 14px; margin-top: 5px;">${comment.text}</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">${comment.timestamp ? new Date(comment.timestamp.toDate()).toLocaleString() : "Just now"}</div>
              </div>
            </div>
            ${currentUser.isAdmin || comment.uid === currentUser.uid ? `<button class="btn-danger" style="padding: 4px 10px; font-size: 11px;" onclick="deleteComment('${postId}', '${doc.id}')">Delete</button>` : ""}
          </div>
        `;
                            commentsListDiv.appendChild(commentDiv);
                        });
                    });
            }

            async function deleteComment(postId, commentId) {
                if (confirm("Are you sure you want to delete this comment?")) {
                    await db.collection("posts").doc(postId).collection("comments").doc(commentId).delete();
                }
            }
        </script>
    </body>
</html>
