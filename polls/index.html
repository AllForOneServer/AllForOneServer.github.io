<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/x-icon" href="/images/favicon-32x32.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Polls</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    
<div id="navbar-container"></div>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>Community Polls</h1>
    <p>Vote on polls and share your opinion</p>
  </div>
  
  <!-- Top Bar (shown when logged in) -->
  <div class="top-bar hidden" id="topBar">
    <div class="user-info-display">
      <div class="top-bar-avatar" id="topBarAvatar"></div>
      <div>
        <div id="topBarName" style="font-weight: 600;"></div>
        <div id="topBarRole" style="font-size: 12px; color: #666;"></div>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
  
  <!-- Login Form -->
  <div class="auth-section centered" id="loginForm">
    <div class="auth-card">
      <h2>Welcome Back</h2>
      <div class="auth-form">
        <div class="input-group">
          <input type="email" id="email" placeholder="Email" />
        </div>
        <div class="input-group">
          <input type="password" id="password" placeholder="Password" />
        </div>
        <button onclick="login()">Login</button>
        <p style="margin-top: 20px;">Don't have an account?</p>
        <button class="secondary-btn" onclick="showSignup()">Sign Up</button>
      </div>
    </div>
  </div>
  
  <!-- Signup Form -->
  <div class="auth-section centered hidden" id="signupForm">
    <div class="auth-card">
      <h2>Create Account</h2>
      <div class="auth-form">
        <div class="input-group">
          <input type="text" id="signupName" placeholder="Full Name" />
        </div>
        <div class="input-group">
          <input type="email" id="signupEmail" placeholder="Email" />
        </div>
        <div class="input-group">
          <input type="password" id="signupPassword" placeholder="Password" />
        </div>
        <button onclick="signup()">Sign Up</button>
        <p style="margin-top: 20px;">Already have an account?</p>
        <button class="secondary-btn" onclick="showLogin()">Login</button>
      </div>
    </div>
  </div>
  
  <!-- Admin notice -->
  <div class="pending-approval centered hidden" id="adminNotice">
    <h2>‚è≥ Pending Approval</h2>
    <p>Your account is awaiting admin approval. You'll be able to access the community once approved.</p>
    <button class="secondary-btn" style="margin-top: 20px;" onclick="logout()">Logout</button>
  </div>
  
  <!-- Main Content -->
  <div class="container centered hidden" id="mainContent">
    
    <!-- Admin Create Poll Form -->
    <div class="post hidden" id="createPollForm" style="margin-bottom: 30px; background: linear-gradient(135deg, #fef3c7, #fff9c4); border: 2px solid #facc15;">
      <h3 style="margin-bottom: 15px;">üìä Create New Poll</h3>
      <div class="input-group">
        <input type="text" id="pollQuestion" placeholder="Poll question" />
      </div>
      <div id="pollOptions">
        <div class="input-group">
          <input type="text" class="poll-option" placeholder="Option 1" />
        </div>
        <div class="input-group">
          <input type="text" class="poll-option" placeholder="Option 2" />
        </div>
      </div>
      <button class="secondary-btn" onclick="addPollOption()" style="margin-bottom: 15px; width: auto; padding: 10px 20px;">+ Add Option</button>
      <div style="display: flex; gap: 10px;">
        <button onclick="createPoll()">Create Poll</button>
        <button class="secondary-btn" onclick="cancelCreatePoll()">Cancel</button>
      </div>
    </div>

    <!-- Admin Panel -->
    <div class="post hidden" id="adminPanel" style="margin-bottom: 30px; background: linear-gradient(135deg, #e0f2fe, #dbeafe); border: 2px solid #3b82f6;">
      <h3 style="margin-bottom: 15px;">üëë Admin Poll Management</h3>
      <button class="secondary-btn" onclick="showCreatePollForm()" style="width: auto; padding: 10px 20px; margin-bottom: 15px;">üìä Create New Poll</button>
      <div id="adminPollsList"></div>
    </div>

    <!-- Active Polls List -->
    <div>
      <h2 style="margin-bottom: 20px;">Active Polls</h2>
      <div id="pollsList"></div>
      <div id="emptyState" class="empty-state hidden">
        <p>No active polls at the moment.</p>
      </div>
    </div>
  </div>
</div>

<!-- Edit Poll Modal -->
<div class="fullscreen-overlay" id="editPollModal">
  <div class="post" style="max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
    <h3 style="margin-bottom: 15px;">Edit Poll</h3>
    <div class="input-group">
      <input type="text" id="editPollQuestion" placeholder="Poll question" />
    </div>
    <div id="editPollOptions"></div>
    <button class="secondary-btn" onclick="addEditPollOption()" style="margin-bottom: 15px; width: auto; padding: 10px 20px;">+ Add Option</button>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button onclick="saveEditPoll()">Save Changes</button>
      <button class="btn-danger" onclick="closeEditPollModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
  // Load Navbar
  fetch('../navbar.html')
    .then(response => {
      if (!response.ok) throw new Error('Navbar not found');
      return response.text();
    })
    .then(html => {
      document.getElementById('navbar-container').innerHTML = html;
    })
    .catch(err => console.error('Failed to load navbar:', err));
    
  // Firebase config
  const firebaseConfig = {
      apiKey: "AIzaSyDzQlAqhCeytCLEYafboYGpFu6pY3Kv9WE",
      authDomain: "allforonemedia-9a7d8.firebaseapp.com",
      projectId: "allforonemedia-9a7d8",
      storageBucket: "allforonemedia-9a7d8.firebasestorage.app",
      messagingSenderId: "892787060584",
      appId: "1:892787060584:web:e65609062592f9ba96f0dd",
      measurementId: "G-JSXKLMBRLC"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;
  let currentEditPollId = null;

  // Check for existing session on page load
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (userDoc.exists && userDoc.data().approved) {
        currentUser = { uid: user.uid, ...userDoc.data() };
        showMainContent();
      } else if (userDoc.exists) {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('adminNotice').classList.remove('hidden');
      } else {
        document.getElementById('loginForm').classList.remove('hidden');
      }
    } else {
      document.getElementById('loginForm').classList.remove('hidden');
    }
  });

  function showSignup() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('signupForm').classList.remove('hidden');
  }

  function showLogin() {
    document.getElementById('signupForm').classList.add('hidden');
    document.getElementById('loginForm').classList.remove('hidden');
  }

  // Signup function
  async function signup() {
    const name = document.getElementById('signupName').value;
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    
    if (!name || !email || !password) {
      alert('Please fill in all fields');
      return;
    }
    
    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const user = userCredential.user;
      await db.collection('users').doc(user.uid).set({ 
        name: name,
        email: email,
        approved: false,
        isAdmin: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Signup successful! Await admin approval.');
      showLogin();
    } catch (error) {
      alert(error.message);
    }
  }

  // Login function
  async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      const user = userCredential.user;
      const userDoc = await db.collection('users').doc(user.uid).get();
      
      if(userDoc.exists && userDoc.data().approved) {
        currentUser = { uid: user.uid, ...userDoc.data() };
        showMainContent();
      } else {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('adminNotice').classList.remove('hidden');
      }
    } catch (error) {
      alert(error.message);
    }
  }

  function logout() {
    auth.signOut();
    location.reload();
  }

  function showMainContent() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('signupForm').classList.add('hidden');
    document.getElementById('adminNotice').classList.add('hidden');
    document.getElementById('topBar').classList.remove('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    
    // Update top bar
    document.getElementById('topBarAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
    document.getElementById('topBarName').textContent = currentUser.name;
    document.getElementById('topBarRole').textContent = currentUser.isAdmin ? 'üëë Admin' : 'Member';
    
    // Show admin features
    if (currentUser.isAdmin) {
      document.getElementById('adminPanel').classList.remove('hidden');
      loadAdminPolls();
    }
    
    loadPolls();
  }

  // Show create poll form
  function showCreatePollForm() {
    document.getElementById('createPollForm').classList.remove('hidden');
    document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
  }

  function cancelCreatePoll() {
    document.getElementById('createPollForm').classList.add('hidden');
    document.getElementById('pollQuestion').value = '';
    const options = document.querySelectorAll('.poll-option');
    options.forEach(opt => opt.value = '');
  }

  // Add poll option
  function addPollOption() {
    const optionsDiv = document.getElementById('pollOptions');
    const optionCount = optionsDiv.querySelectorAll('.poll-option').length + 1;
    const newOption = document.createElement('div');
    newOption.className = 'input-group';
    newOption.innerHTML = `<input type="text" class="poll-option" placeholder="Option ${optionCount}" />`;
    optionsDiv.appendChild(newOption);
  }

  // Create poll
  async function createPoll() {
    const question = document.getElementById('pollQuestion').value.trim();
    const optionInputs = document.querySelectorAll('.poll-option');
    const options = [];
    
    optionInputs.forEach(input => {
      const value = input.value.trim();
      if (value) {
        options.push({
          text: value,
          votes: []
        });
      }
    });
    
    if (!question) {
      alert('Please enter a poll question');
      return;
    }
    
    if (options.length < 2) {
      alert('Please add at least 2 options');
      return;
    }
    
    try {
      await db.collection('polls').add({
        question: question,
        options: options,
        createdBy: currentUser.uid,
        createdByName: currentUser.name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        active: true
      });
      
      alert('Poll created successfully!');
      cancelCreatePoll();
      loadAdminPolls();
    } catch (error) {
      alert('Error creating poll: ' + error.message);
    }
  }

  // Load polls for regular users
  function loadPolls() {
    const pollsList = document.getElementById('pollsList');
    const emptyState = document.getElementById('emptyState');
    
    db.collection('polls').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      pollsList.innerHTML = '';
      
      // Filter active polls on client side
      const activePolls = [];
      snapshot.forEach(doc => {
        const poll = doc.data();
        if (poll.active) {
          activePolls.push({ id: doc.id, data: poll });
        }
      });
      
      if (activePolls.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      activePolls.forEach(({ id: pollId, data: poll }) => {
        const totalVotes = poll.options.reduce((sum, opt) => sum + opt.votes.length, 0);
        const userVoted = poll.options.some(opt => opt.votes.includes(currentUser.uid));
        
        const div = document.createElement('div');
        div.className = 'post';
        div.style.marginBottom = '20px';
        
        let optionsHTML = '';
        poll.options.forEach((option, index) => {
          const voteCount = option.votes.length;
          const percentage = totalVotes > 0 ? Math.round((voteCount / totalVotes) * 100) : 0;
          const hasVoted = option.votes.includes(currentUser.uid);
          
          if (userVoted) {
            // Show results
            optionsHTML += `
              <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                  <span style="font-weight: ${hasVoted ? '600' : '400'};">${hasVoted ? '‚úì ' : ''}${option.text}</span>
                  <span style="color: #666;">${voteCount} votes (${percentage}%)</span>
                </div>
                <div style="background: #e0e0e0; height: 30px; border-radius: 8px; overflow: hidden; position: relative;">
                  <div style="background: ${hasVoted ? '#10b981' : '#4a86e8'}; height: 100%; width: ${percentage}%; transition: width 0.3s; display: flex; align-items: center; padding-left: 10px; color: white; font-size: 14px; font-weight: 600;">
                    ${percentage > 0 ? percentage + '%' : ''}
                  </div>
                </div>
              </div>
            `;
          } else {
            // Show voting buttons
            optionsHTML += `
              <button class="secondary-btn" onclick="vote('${pollId}', ${index})" style="margin-bottom: 10px; text-align: left;">
                ${option.text}
              </button>
            `;
          }
        });
        
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <div style="display: flex; gap: 12px; align-items: center;">
              <div class="post-avatar" style="width: 40px; height: 40px; font-size: 18px;">
                ${poll.createdByName.charAt(0).toUpperCase()}
              </div>
              <div>
                <div style="font-weight: 600;">${poll.createdByName}</div>
                <div style="font-size: 12px; color: #666;">${poll.createdAt ? new Date(poll.createdAt.toDate()).toLocaleString() : 'Just now'}</div>
              </div>
            </div>
          </div>
          <h3 style="margin-bottom: 20px;">üìä ${poll.question}</h3>
          ${optionsHTML}
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; color: #666; font-size: 14px;">
            Total votes: ${totalVotes}
          </div>
        `;
        
        pollsList.appendChild(div);
      });
    });
  }

  // Vote on poll
  async function vote(pollId, optionIndex) {
    try {
      const pollRef = db.collection('polls').doc(pollId);
      const pollDoc = await pollRef.get();
      const poll = pollDoc.data();
      
      // Check if user already voted
      const alreadyVoted = poll.options.some(opt => opt.votes.includes(currentUser.uid));
      if (alreadyVoted) {
        alert('You have already voted on this poll');
        return;
      }
      
      // Add vote
      poll.options[optionIndex].votes.push(currentUser.uid);
      await pollRef.update({ options: poll.options });
      
    } catch (error) {
      alert('Error voting: ' + error.message);
    }
  }

  // Load admin polls
  function loadAdminPolls() {
    const adminPollsList = document.getElementById('adminPollsList');
    
    db.collection('polls').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      adminPollsList.innerHTML = '';
      
      if (snapshot.empty) {
        adminPollsList.innerHTML = '<p style="text-align: center; color: #666;">No polls created yet</p>';
        return;
      }
      
      snapshot.forEach(doc => {
        const poll = doc.data();
        const pollId = doc.id;
        const totalVotes = poll.options.reduce((sum, opt) => sum + opt.votes.length, 0);
        
        const div = document.createElement('div');
        div.style.cssText = 'background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px;';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 5px;">${poll.question}</div>
              <div style="font-size: 12px; color: #666;">
                ${poll.options.length} options | ${totalVotes} total votes | 
                Status: ${poll.active ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
              </div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="secondary-btn" style="width: auto; padding: 8px 15px; font-size: 14px;" onclick="editPoll('${pollId}')">Edit</button>
              <button class="secondary-btn" style="width: auto; padding: 8px 15px; font-size: 14px;" onclick="togglePollStatus('${pollId}', ${poll.active})">
                ${poll.active ? 'Deactivate' : 'Activate'}
              </button>
              <button class="btn-danger" style="padding: 8px 15px; font-size: 14px;" onclick="deletePoll('${pollId}')">Delete</button>
            </div>
          </div>
        `;
        
        adminPollsList.appendChild(div);
      });
    });
  }

  // Toggle poll active status
  async function togglePollStatus(pollId, currentStatus) {
    try {
      await db.collection('polls').doc(pollId).update({
        active: !currentStatus
      });
      alert(currentStatus ? 'Poll deactivated' : 'Poll activated');
    } catch (error) {
      alert('Error updating poll: ' + error.message);
    }
  }

  // Delete poll
  async function deletePoll(pollId) {
    if (confirm('Are you sure you want to delete this poll? This cannot be undone.')) {
      try {
        await db.collection('polls').doc(pollId).delete();
        alert('Poll deleted successfully');
      } catch (error) {
        alert('Error deleting poll: ' + error.message);
      }
    }
  }

  // Edit poll
  async function editPoll(pollId) {
    currentEditPollId = pollId;
    const pollDoc = await db.collection('polls').doc(pollId).get();
    const poll = pollDoc.data();
    
    document.getElementById('editPollQuestion').value = poll.question;
    
    const editOptionsDiv = document.getElementById('editPollOptions');
    editOptionsDiv.innerHTML = '';
    
    poll.options.forEach((option, index) => {
      const div = document.createElement('div');
      div.className = 'input-group';
      div.innerHTML = `
        <input type="text" class="edit-poll-option" placeholder="Option ${index + 1}" value="${option.text}" data-votes='${JSON.stringify(option.votes)}' />
      `;
      editOptionsDiv.appendChild(div);
    });
    
    document.getElementById('editPollModal').classList.add('active');
  }

  function closeEditPollModal() {
    document.getElementById('editPollModal').classList.remove('active');
    currentEditPollId = null;
  }

  function addEditPollOption() {
    const optionsDiv = document.getElementById('editPollOptions');
    const optionCount = optionsDiv.querySelectorAll('.edit-poll-option').length + 1;
    const newOption = document.createElement('div');
    newOption.className = 'input-group';
    newOption.innerHTML = `<input type="text" class="edit-poll-option" placeholder="Option ${optionCount}" data-votes='[]' />`;
    optionsDiv.appendChild(newOption);
  }

  async function saveEditPoll() {
    const question = document.getElementById('editPollQuestion').value.trim();
    const optionInputs = document.querySelectorAll('.edit-poll-option');
    const options = [];
    
    optionInputs.forEach(input => {
      const value = input.value.trim();
      if (value) {
        const votes = JSON.parse(input.getAttribute('data-votes') || '[]');
        options.push({
          text: value,
          votes: votes
        });
      }
    });
    
    if (!question) {
      alert('Please enter a poll question');
      return;
    }
    
    if (options.length < 2) {
      alert('Please add at least 2 options');
      return;
    }
    
    try {
      await db.collection('polls').doc(currentEditPollId).update({
        question: question,
        options: options
      });
      
      alert('Poll updated successfully!');
      closeEditPollModal();
    } catch (error) {
      alert('Error updating poll: ' + error.message);
    }
  }
</script>
</body>
</html>