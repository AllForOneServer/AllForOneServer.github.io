<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Community Polls</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell,
                    sans-serif;
                background: #f9f9f9;
                color: #1c1c1c;
                min-height: 100vh;
            }

            .header {
                padding: 20px 30px;
                color: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                background: linear-gradient(90deg, #1e90ff, #4a86e8);
            }

            .header h1 {
                font-size: 28px;
                margin-bottom: 5px;
            }

            .header p {
                opacity: 0.9;
                font-size: 14px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 30px;
            }

            .auth-card {
                background: white;
                border-radius: 12px;
                padding: 40px;
                max-width: 450px;
                margin: 60px auto;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }

            .auth-card h2 {
                margin-bottom: 25px;
                text-align: center;
            }

            .input-group {
                margin-bottom: 20px;
            }

            .input-group input,
            .input-group textarea {
                width: 100%;
                padding: 14px 18px;
                border: 1px solid #e0e0e0;
                border-radius: 10px;
                font-size: 15px;
                background: #f9f9f9;
                font-family: inherit;
            }

            .input-group input:focus,
            .input-group textarea:focus {
                outline: none;
                border-color: #1e90ff;
                background: white;
            }

            .btn {
                width: 100%;
                padding: 14px;
                background: #1e90ff;
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s;
            }

            .btn:hover {
                background: #1873cc;
                transform: translateY(-1px);
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            .btn-secondary {
                background: #4a86e8;
            }

            .btn-danger {
                background: #ef4444;
                padding: 10px 20px;
                width: auto;
            }

            .toggle-link {
                text-align: center;
                margin-top: 20px;
                color: #1e90ff;
                cursor: pointer;
                text-decoration: underline;
            }

            .message {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 20px;
                font-size: 14px;
            }

            .message-error {
                background: #fff1f2;
                color: #ef4444;
                border: 1px solid #fee2e2;
            }

            .message-success {
                background: #ecfdf5;
                color: #047857;
                border: 1px solid #d1fae5;
            }

            .top-bar {
                background: white;
                padding: 15px 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #e0e0e0;
            }

            .user-info {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .user-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: linear-gradient(135deg, #4a86e8, #1e90ff);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
                font-size: 16px;
            }

            .btn-group {
                display: flex;
                gap: 10px;
            }

            .main-content {
                display: grid;
                grid-template-columns: 350px 1fr;
                gap: 30px;
                margin-top: 30px;
            }

            .polls-list {
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                height: fit-content;
            }

            .polls-list h3 {
                color: #1e90ff;
                margin-bottom: 20px;
                font-size: 18px;
            }

            .poll-item {
                padding: 16px;
                border: 1px solid #e0e0e0;
                border-radius: 10px;
                margin-bottom: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .poll-item:hover {
                border-color: #1e90ff;
                background: #f0f8ff;
            }

            .poll-item.active {
                background: #e3f2fd;
                border-color: #1e90ff;
                border-width: 2px;
            }

            .poll-item h4 {
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 8px;
            }

            .poll-badge {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 500;
                white-space: nowrap;
            }

            .badge-ended {
                background: #ef4444;
                color: white;
            }

            .badge-voted {
                background: #10b981;
                color: white;
            }

            .poll-desc {
                font-size: 14px;
                color: #666;
                margin-bottom: 8px;
            }

            .poll-meta {
                font-size: 12px;
                color: #999;
            }

            .poll-detail {
                background: white;
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #666;
            }

            .options-list {
                margin: 30px 0;
            }

            .option-item {
                padding: 16px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                margin-bottom: 12px;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .option-item:hover {
                border-color: #1e90ff;
            }

            .option-item.selected {
                border-color: #1e90ff;
                background: #e3f2fd;
            }

            .radio {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 2px solid #1e90ff;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .radio-inner {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #1e90ff;
            }

            .result-item {
                margin-bottom: 20px;
            }

            .result-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                font-size: 14px;
            }

            .result-bar {
                height: 30px;
                background: #e0e0e0;
                border-radius: 8px;
                overflow: hidden;
            }

            .result-bar-fill {
                height: 100%;
                background: linear-gradient(135deg, #1e90ff, #4a86e8);
                transition: width 0.5s ease;
            }

            .winner-box {
                background: linear-gradient(135deg, #fef3c7, #fde68a);
                padding: 20px;
                border-radius: 12px;
                margin-top: 30px;
                text-align: center;
                border: 2px solid #fbbf24;
            }

            .winner-box h4 {
                margin-bottom: 10px;
            }

            .create-poll-form {
                background: white;
                border-radius: 12px;
                padding: 30px;
                margin-bottom: 30px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }

            .create-poll-form h3 {
                margin-bottom: 20px;
            }

            .option-input-group {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .option-input-group input {
                flex: 1;
            }

            .btn-small {
                padding: 10px 15px;
                width: auto;
            }

            .btn-remove {
                background: #ef4444;
                width: 40px;
                padding: 10px;
            }

            .label {
                display: block;
                margin-bottom: 8px;
                color: #1c1c1c;
                font-weight: 500;
            }

            .already-voted,
            .poll-ended-notice {
                padding: 16px;
                border-radius: 10px;
                margin-bottom: 20px;
                border: 1px solid;
            }

            .already-voted {
                background: #ecfdf5;
                border-color: #d1fae5;
                color: #047857;
            }

            .poll-ended-notice {
                background: #fff1f2;
                border-color: #fee2e2;
                color: #ef4444;
            }

            .hidden {
                display: none;
            }

            @media (max-width: 768px) {
                .main-content {
                    grid-template-columns: 1fr;
                }

                .top-bar {
                    flex-direction: column;
                    gap: 15px;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>Community Polls</h1>
            <p>Vote on topics that matter to you</p>
        </div>

        <div id="navbar-placeholder"></div>
        <script>
            fetch("https://allforoneserver.github.io/navigation.html")
                .then((response) => response.text())
                .then((data) => {
                    document.getElementById("navbar-placeholder").innerHTML = data;
                    const scripts = document.getElementById("navbar-placeholder").getElementsByTagName("script");
                    for (let script of scripts) {
                        try {
                            (0, eval)(script.innerHTML);
                        } catch (e) {
                            console.warn("Navbar script error", e);
                        }
                    }
                })
                .catch((error) => console.error("Error loading navbar:", error));
        </script>

        <!-- Auth Screen -->
        <div id="authScreen">
            <div class="auth-card">
                <h2 id="authTitle">Welcome Back</h2>
                <div id="authMessage" class="hidden"></div>

                <form id="authForm">
                    <div id="displayNameGroup" class="input-group hidden">
                        <input type="text" id="displayNameInput" placeholder="Display Name" />
                    </div>

                    <div class="input-group">
                        <input type="email" id="emailInput" placeholder="Email" required />
                    </div>

                    <div class="input-group">
                        <input type="password" id="passwordInput" placeholder="Password" required />
                    </div>

                <button type="submit" class="btn" id="authSubmitBtn">Log In</button>

                    <div class="toggle-link" id="authToggle">Need an account? Sign up</div>
                </form>
            </div>
        </div>

        <!-- Pending Approval Screen -->
        <div id="pendingScreen" class="hidden">
            <div class="auth-card">
                <h2>Account Pending Approval</h2>
                <p style="margin: 20px 0; text-align: center; color: #666">
                    Your account has been created and is awaiting approval from an administrator. You'll be able to
                    access the polls once your account is approved.
                </p>
                <button class="btn btn-danger" onclick="logout()">Back to Login</button>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="mainScreen" class="hidden">
            <div class="top-bar">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">User</span>
                </div>

                <div class="btn-group">
                    <button class="btn btn-small btn-secondary hidden" id="createPollBtn">+ Create Poll</button>
                    <button class="btn" onclick="authManager.handleLogout()">Logout</button>
                </div>
            </div>

            <div class="container">
                <div id="authMessage2" class="hidden"></div>

                <!-- Create Poll Form -->
                <div id="createPollForm" class="create-poll-form hidden">
                    <h3>Create New Poll</h3>
                    <form id="pollForm">
                        <div class="input-group">
                            <input type="text" id="pollTitle" placeholder="Poll Title" required />
                        </div>

                        <div class="input-group">
                            <textarea id="pollDescription" placeholder="Poll Description" rows="3" required></textarea>
                        </div>

                        <div class="input-group">
                            <label class="label">Poll End Date:</label>
                            <input type="datetime-local" id="pollEndDate" required />
                        </div>

                        <label class="label">Options:</label>
                        <div id="optionsContainer"></div>

                        <button
                            type="button"
                            class="btn btn-secondary btn-small"
                            onclick="addOption()"
                            style="margin-bottom: 15px">
                            + Add Option
                        </button>

                        <button type="submit" class="btn">Create Poll</button>
                    </form>
                </div>

                <!-- Main Content -->
                <div class="main-content">
                    <!-- Polls List -->
                    <div class="polls-list">
                        <h3>Available Polls</h3>
                        <div id="pollsList"></div>
                    </div>

                    <!-- Poll Detail -->
                    <div class="poll-detail">
                        <div id="pollDetail">
                            <div class="empty-state">
                                <h3>Select a Poll</h3>
                                <p>Choose a poll from the list to vote or view results</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
        <script type="module">
// ============================================================================
// FIREBASE IMPORTS & CONFIGURATION
// ============================================================================

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    updateProfile
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
    getFirestore,
    collection,
    addDoc,
    query,
    orderBy,
    onSnapshot,
    serverTimestamp,
    deleteDoc,
    doc,
    updateDoc,
    getDoc,
    setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDzQlAqhCeytCLEYafboYGpFu6pY3Kv9WE",
    authDomain: "allforonemedia-9a7d8.firebaseapp.com",
    projectId: "allforonemedia-9a7d8",
    storageBucket: "allforonemedia-9a7d8.firebasestorage.app",
    messagingSenderId: "892787060584",
    appId: "1:892787060584:web:e65609062592f9ba96f0dd",
    measurementId: "G-JSXKLMBRLC"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ============================================================================
// CONSTANTS
// ============================================================================

const CLOUDINARY_CLOUD_NAME = "dgrmpcha9";
const CLOUDINARY_UPLOAD_PRESET = "AllForOne Posts";
const ADMIN_EMAIL = "kaioliver111@gmail.com";

const COLLECTIONS = {
    POSTS: 'MessagesPosts',
    USERS: 'MessageUsers'
};

const PROFANITY_LIST = [
    "damn", "hell", "crap", "shit", "fuck", "ass", "bitch", "bastard",
    "dick", "piss", "cock", "pussy", "whore", "slut", "fag", "nigger",
    "cunt", "twat", "wanker", "bollocks", "arse", "bugger"
];

// ============================================================================
// ============================================================================
// FIREBASE AUTHENTICATION MODULE - START
// ============================================================================
// ============================================================================

// ----------------------------------------------------------------------------
// Authentication Configuration
// ----------------------------------------------------------------------------
const AUTH_CONFIG = {
    adminEmail: ADMIN_EMAIL,
    usersCollection: COLLECTIONS.USERS,
    elementIds: {
        authSection: "authSection",
        pendingSection: "pendingSection",
        mainContent: "mainContent",
        authError: "authError",
        authSuccess: "authSuccess",
        authTitle: "authTitle",
        emailInput: "emailInput",
        passwordInput: "passwordInput",
        displayNameInput: "displayNameInput",
        displayNameGroup: "displayNameGroup",
        primaryBtn: "primaryBtn",
        toggleAuth: "toggleAuth",
        backToLoginBtn: "backToLoginBtn",
        currentUserDisplay: "currentUserDisplay",
        userAvatar: "userAvatar",
        adminOptions: "adminOptions"
    }
};

// ----------------------------------------------------------------------------
// Authentication State
// ----------------------------------------------------------------------------
const authState = {
    currentUser: null,
    isSignupMode: false,
    isAdmin: false,
    approvalListener: null
};

// ----------------------------------------------------------------------------
// Authentication DOM Elements
// ----------------------------------------------------------------------------
let authElements = {};

function initializeAuthElements() {
    authElements = {
        authSection: document.getElementById(AUTH_CONFIG.elementIds.authSection),
        pendingSection: document.getElementById(AUTH_CONFIG.elementIds.pendingSection),
        mainContent: document.getElementById(AUTH_CONFIG.elementIds.mainContent),
        authError: document.getElementById(AUTH_CONFIG.elementIds.authError),
        authSuccess: document.getElementById(AUTH_CONFIG.elementIds.authSuccess),
        authTitle: document.getElementById(AUTH_CONFIG.elementIds.authTitle),
        emailInput: document.getElementById(AUTH_CONFIG.elementIds.emailInput),
        passwordInput: document.getElementById(AUTH_CONFIG.elementIds.passwordInput),
        displayNameInput: document.getElementById(AUTH_CONFIG.elementIds.displayNameInput),
        displayNameGroup: document.getElementById(AUTH_CONFIG.elementIds.displayNameGroup),
        primaryBtn: document.getElementById(AUTH_CONFIG.elementIds.primaryBtn),
        toggleAuth: document.getElementById(AUTH_CONFIG.elementIds.toggleAuth),
        backToLoginBtn: document.getElementById(AUTH_CONFIG.elementIds.backToLoginBtn),
        currentUserDisplay: document.getElementById(AUTH_CONFIG.elementIds.currentUserDisplay),
        userAvatar: document.getElementById(AUTH_CONFIG.elementIds.userAvatar),
        adminOptions: document.getElementById(AUTH_CONFIG.elementIds.adminOptions)
    };
}

// ----------------------------------------------------------------------------
// Authentication Utilities
// ----------------------------------------------------------------------------
const authUtils = {
    showError(message) {
        if (authElements.authError) {
            authElements.authError.textContent = message;
            authElements.authError.classList.remove("hidden");
            setTimeout(() => authElements.authError.classList.add("hidden"), 5000);
        } else {
            console.error("Auth Error:", message);
            alert(message);
        }
    },

    showSuccess(message) {
        if (authElements.authSuccess) {
            authElements.authSuccess.textContent = message;
            authElements.authSuccess.classList.remove("hidden");
            setTimeout(() => authElements.authSuccess.classList.add("hidden"), 3000);
        } else {
            console.log("Auth Success:", message);
        }
    },

    validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    },

    validatePassword(password) {
        return password.length >= 6;
    }
};

// ----------------------------------------------------------------------------
// Authentication Firestore Operations
// ----------------------------------------------------------------------------
const authFirestoreOps = {
    async createUser(uid, displayName, email) {
        try {
            await setDoc(doc(db, AUTH_CONFIG.usersCollection, uid), {
                uid: uid,
                displayName: displayName,
                email: email,
                approved: false,
                createdAt: serverTimestamp(),
                lastSeen: serverTimestamp()
            });
            console.log("User document created in", AUTH_CONFIG.usersCollection);
        } catch (error) {
            console.error("Error creating user document:", error);
            throw error;
        }
    },

    async getUser(uid) {
        try {
            const userDoc = await getDoc(doc(db, AUTH_CONFIG.usersCollection, uid));
            if (!userDoc.exists()) {
                console.log("User document doesn't exist yet");
                return null;
            }
            return userDoc.data();
        } catch (error) {
            console.error("Error fetching user:", error);
            return null;
        }
    },

    async updateUserLastSeen(uid) {
        try {
            await updateDoc(doc(db, AUTH_CONFIG.usersCollection, uid), {
                lastSeen: serverTimestamp()
            });
        } catch (error) {
            console.error("Error updating last seen:", error);
        }
    },

    subscribeToUserApproval(uid, callback) {
        return onSnapshot(
            doc(db, AUTH_CONFIG.usersCollection, uid),
            callback,
            (error) => {
                console.error("Error listening for approval:", error);
            }
        );
    }
};

// ----------------------------------------------------------------------------
// Authentication Manager
// ----------------------------------------------------------------------------
const authManager = {
    toggleAuthMode() {
        authState.isSignupMode = !authState.isSignupMode;
        
        if (authState.isSignupMode) {
            authElements.authTitle.textContent = "Create Your Account";
            authElements.primaryBtn.textContent = "Sign Up";
            authElements.toggleAuth.textContent = "Already have an account? Log in";
            authElements.displayNameGroup.classList.remove("hidden");
        } else {
            authElements.authTitle.textContent = "Welcome Back";
            authElements.primaryBtn.textContent = "Log In";
            authElements.toggleAuth.textContent = "Need an account? Sign up";
            authElements.displayNameGroup.classList.add("hidden");
        }
    },

    async handleSignUp(email, password, displayName) {
        try {
            if (!displayName || displayName.trim() === "") {
                throw new Error("Please enter a display name");
            }

            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            await updateProfile(user, { displayName: displayName.trim() });
            await authFirestoreOps.createUser(user.uid, displayName.trim(), email);

            authUtils.showSuccess("Account created! Awaiting approval...");

            authElements.emailInput.value = "";
            authElements.passwordInput.value = "";
            authElements.displayNameInput.value = "";
        } catch (error) {
            console.error("Sign up error:", error);
            throw error;
        }
    },

    async handleLogin(email, password) {
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error("Login error:", error);
            throw error;
        }
    },

    async handleLogout() {
        try {
            if (authState.approvalListener) {
                try {
                    authState.approvalListener();
                } catch (e) {
                    console.error("Error unsubscribing:", e);
                }
                authState.approvalListener = null;
            }

            await signOut(auth);
            authState.currentUser = null;
            authState.isAdmin = false;
        } catch (error) {
            console.error("Logout error:", error);
            throw error;
        }
    },

    async backToLogin() {
        await this.handleLogout();
        authElements.pendingSection.classList.add("hidden");
        authElements.authSection.classList.remove("hidden");
        authState.isSignupMode = false;
        authElements.authTitle.textContent = "Welcome Back";
        authElements.primaryBtn.textContent = "Log In";
        authElements.toggleAuth.textContent = "Need an account? Sign up";
        authElements.displayNameGroup.classList.add("hidden");
    },

    getCurrentUser() {
        return authState.currentUser;
    },

    isAdmin() {
        return authState.isAdmin;
    }
};

// ----------------------------------------------------------------------------
// Authentication UI Manager
// ----------------------------------------------------------------------------
const authUIManager = {
    showAuthScreen() {
        authElements.authSection?.classList.remove("hidden");
        authElements.pendingSection?.classList.add("hidden");
        authElements.mainContent?.classList.add("hidden");
    },

    showPendingScreen() {
        authElements.authSection?.classList.add("hidden");
        authElements.pendingSection?.classList.remove("hidden");
        authElements.mainContent?.classList.add("hidden");
        this.updateUserInfo();
    },

    showMainScreen() {
        authElements.authSection?.classList.add("hidden");
        authElements.pendingSection?.classList.add("hidden");
        authElements.mainContent?.classList.remove("hidden");
        this.updateUserInfo();
    },

    updateUserInfo() {
        if (!authState.currentUser) return;

        const displayName = authState.currentUser.displayName || authState.currentUser.email;
        
        if (authElements.currentUserDisplay) {
            authElements.currentUserDisplay.textContent = displayName;
        }
        
        if (authElements.userAvatar) {
            authElements.userAvatar.textContent = displayName[0].toUpperCase();
        }

        if (authState.isAdmin && authElements.adminOptions) {
            authElements.adminOptions.classList.remove("hidden");
        } else if (authElements.adminOptions) {
            authElements.adminOptions.classList.add("hidden");
        }
    }
};

// ----------------------------------------------------------------------------
// Authentication Event Listeners
// ----------------------------------------------------------------------------
function setupAuthEventListeners() {
    // Toggle between sign up and login
    authElements.toggleAuth?.addEventListener("click", () => {
        authManager.toggleAuthMode();
    });

    // Back to login button
    authElements.backToLoginBtn?.addEventListener("click", () => {
        authManager.backToLogin();
    });

    // Primary button (Sign Up / Log In)
    authElements.primaryBtn?.addEventListener("click", async () => {
        const email = authElements.emailInput.value.trim();
        const password = authElements.passwordInput.value;

        if (!email || !password) {
            authUtils.showError("Please fill in email and password");
            return;
        }

        if (!authUtils.validateEmail(email)) {
            authUtils.showError("Please enter a valid email");
            return;
        }

        if (!authUtils.validatePassword(password)) {
            authUtils.showError("Password must be at least 6 characters");
            return;
        }

        try {
            authElements.primaryBtn.disabled = true;
            authElements.primaryBtn.textContent = "Loading...";

            if (authState.isSignupMode) {
                const displayName = authElements.displayNameInput.value.trim();
                if (!displayName) {
                    authUtils.showError("Please enter a display name");
                    return;
                }
                await authManager.handleSignUp(email, password, displayName);
            } else {
                await authManager.handleLogin(email, password);
            }
        } catch (error) {
            let errorMessage = "An error occurred";

            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = "Email already in use";
                    break;
                case 'auth/invalid-email':
                    errorMessage = "Invalid email address";
                    break;
                case 'auth/weak-password':
                    errorMessage = "Password is too weak";
                    break;
                case 'auth/user-not-found':
                    errorMessage = "User not found";
                    break;
                case 'auth/wrong-password':
                    errorMessage = "Incorrect password";
                    break;
                case 'auth/invalid-credential':
                    errorMessage = "Invalid email or password";
                    break;
                default:
                    errorMessage = error.message.replace("Firebase: ", "");
            }

            authUtils.showError(errorMessage);
        } finally {
            authElements.primaryBtn.disabled = false;
            authElements.primaryBtn.textContent = authState.isSignupMode ? "Sign Up" : "Log In";
        }
    });

    // Enter key support
    [authElements.emailInput, authElements.passwordInput, authElements.displayNameInput].forEach(input => {
        if (input) {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    authElements.primaryBtn.click();
                }
            });
        }
    });

    // Auth state listener - MAIN AUTHENTICATION FLOW
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("User signed in:", user.uid);
            authState.currentUser = user;

            await new Promise(resolve => setTimeout(resolve, 500));

            try {
                const userData = await authFirestoreOps.getUser(user.uid);

                if (!userData) {
                    console.error("User data not found after sign in");
                    authUtils.showError("Error loading user data. Please try again.");
                    await authManager.handleLogout();
                    return;
                }

                console.log("User data loaded:", userData);

                if (userData.approved === true) {
                    // User approved - show main app
                    authUIManager.showMainScreen();

                    authState.isAdmin = user.email === AUTH_CONFIG.adminEmail;
                    await authFirestoreOps.updateUserLastSeen(user.uid);

                    if (authState.approvalListener) {
                        try {
                            authState.approvalListener();
                        } catch (e) {}
                        authState.approvalListener = null;
                    }

                    // Load posts after authentication
                    if (typeof uiManager !== 'undefined' && uiManager.loadPosts) {
                        uiManager.loadPosts();
                    }

                    // Trigger custom event
                    window.dispatchEvent(new CustomEvent('userAuthenticated', { 
                        detail: { 
                            user: authState.currentUser, 
                            isAdmin: authState.isAdmin 
                        } 
                    }));

                } else {
                    // User pending approval
                    authUIManager.showPendingScreen();

                    authState.approvalListener = authFirestoreOps.subscribeToUserApproval(
                        user.uid,
                        (doc) => {
                            if (doc.exists() && doc.data().approved === true) {
                                console.log("User approved! Reloading...");
                                if (authState.approvalListener) {
                                    try {
                                        authState.approvalListener();
                                    } catch (e) {}
                                    authState.approvalListener = null;
                                }
                                window.location.reload();
                            }
                        }
                    );
                }
            } catch (error) {
                console.error("Error in auth state change:", error);
                authUtils.showError("Error loading user data");
            }
        } else {
            // User signed out
            console.log("User signed out");
            authState.currentUser = null;
            authState.isAdmin = false;
            authUIManager.showAuthScreen();

            if (authState.approvalListener) {
                try {
                    authState.approvalListener();
                } catch (e) {}
                authState.approvalListener = null;
            }

            // Trigger custom event
            window.dispatchEvent(new Event('userSignedOut'));
        }
    });
}

// ----------------------------------------------------------------------------
// Initialize Authentication
// ----------------------------------------------------------------------------
function initializeAuth() {
    console.log("Initializing authentication system...");
    initializeAuthElements();
    setupAuthEventListeners();
    console.log("Authentication system ready");
}

// ============================================================================
// ============================================================================
// FIREBASE AUTHENTICATION MODULE - END
// ============================================================================
// ============================================================================

// ============================================================================
// STATE MANAGEMENT (For Posts)
// ============================================================================

const state = {
    uploadedMedia: [],
    currentMediaArray: [],
    currentMediaIndex: 0
};

// ============================================================================
// DOM ELEMENTS (For Posts)
// ============================================================================

const elements = {
    // Post elements
    postError: document.getElementById("postError"),
    postInput: document.getElementById("postInput"),
    postHeading: document.getElementById("postHeading"),
    postBtn: document.getElementById("postBtn"),
    postsContainer: document.getElementById("postsContainer"),
    announcementCheck: document.getElementById("announcementCheck"),
    adminOptions: document.getElementById("adminOptions"),

    // Media upload
    uploadImageBtn: document.getElementById("uploadImageBtn"),
    uploadVideoBtn: document.getElementById("uploadVideoBtn"),
    imageInput: document.getElementById("imageInput"),
    videoInput: document.getElementById("videoInput"),
    mediaPreview: document.getElementById("mediaPreview"),
    uploadingIndicator: document.getElementById("uploadingIndicator"),

    // Fullscreen overlay
    fullscreenOverlay: document.getElementById("fullscreenOverlay"),
    fullscreenContent: document.getElementById("fullscreenContent"),
    fullscreenClose: document.getElementById("fullscreenClose"),
    fullscreenPrev: document.getElementById("fullscreenPrev"),
    fullscreenNext: document.getElementById("fullscreenNext")
};

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

const utils = {
    filterProfanity(text) {
        let filtered = text;
        PROFANITY_LIST.forEach((word) => {
            const regex = new RegExp(`\\b${word}\\b`, "gi");
            filtered = filtered.replace(regex, "***");
        });
        return filtered;
    },

    showError(message, errorElement) {
        errorElement.textContent = message;
        errorElement.classList.remove("hidden");
        setTimeout(() => errorElement.classList.add("hidden"), 5000);
    },

    formatTime(timestamp) {
        if (!timestamp) return "Just now";
        return timestamp.toDate().toLocaleString([], {
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        });
    },

    escapeHtml(unsafe) {
        if (typeof unsafe !== "string") return unsafe;
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
};

// ============================================================================
// FIRESTORE OPERATIONS (For Posts)
// ============================================================================

const firestoreOps = {
    async createPost(postData) {
        await addDoc(collection(db, COLLECTIONS.POSTS), {
            ...postData,
            timestamp: serverTimestamp()
        });
    },

    async deletePost(postId) {
        await deleteDoc(doc(db, COLLECTIONS.POSTS, postId));
    },

    async updatePost(postId, data) {
        await updateDoc(doc(db, COLLECTIONS.POSTS, postId), data);
    },

    subscribeToPosts(callback) {
        const postsQuery = query(
            collection(db, COLLECTIONS.POSTS),
            orderBy("timestamp", "desc")
        );
        return onSnapshot(postsQuery, callback);
    }
};

// ============================================================================
// CLOUDINARY UPLOAD
// ============================================================================

const cloudinaryManager = {
    async uploadFile(file, resourceType) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
        formData.append("resource_type", resourceType);

        try {
            const response = await fetch(
                `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`,
                {
                    method: "POST",
                    body: formData
                }
            );

            const data = await response.json();
            return {
                url: data.secure_url,
                type: resourceType,
                publicId: data.public_id
            };
        } catch (error) {
            console.error("Upload error:", error);
            throw error;
        }
    },

    async handleFileUpload(files, type) {
        if (!files.length) return;

        elements.uploadingIndicator.classList.remove("hidden");
        elements.uploadImageBtn.disabled = true;
        elements.uploadVideoBtn.disabled = true;

        try {
            for (const file of files) {
                const mediaData = await this.uploadFile(file, type);
                state.uploadedMedia.push(mediaData);
                mediaManager.addPreview(mediaData);
            }
        } catch (error) {
            utils.showError("Failed to upload media. Please try again.", elements.postError);
        } finally {
            elements.uploadingIndicator.classList.add("hidden");
            elements.uploadImageBtn.disabled = false;
            elements.uploadVideoBtn.disabled = false;
        }
    }
};

// ============================================================================
// MEDIA MANAGEMENT
// ============================================================================

const mediaManager = {
    addPreview(mediaData) {
        const previewItem = document.createElement("div");
        previewItem.className = "media-preview-item";
        previewItem.dataset.publicId = mediaData.publicId;

        if (mediaData.type === "image") {
            previewItem.innerHTML = `
                <img src="${mediaData.url}" alt="Preview" />
                <button class="media-preview-remove">×</button>
            `;
        } else {
            previewItem.innerHTML = `
                <video src="${mediaData.url}" muted></video>
                <button class="media-preview-remove">×</button>
            `;
        }

        const removeBtn = previewItem.querySelector(".media-preview-remove");
        removeBtn.addEventListener("click", () => {
            state.uploadedMedia = state.uploadedMedia.filter((m) => m.publicId !== mediaData.publicId);
            previewItem.remove();
        });

        elements.mediaPreview.appendChild(previewItem);
    },

    openFullscreen(mediaArray, index) {
        state.currentMediaArray = mediaArray;
        state.currentMediaIndex = index;
        this.showFullscreenMedia();
        elements.fullscreenOverlay.classList.add("active");
        document.body.style.overflow = "hidden";
    },

    showFullscreenMedia() {
        const media = state.currentMediaArray[state.currentMediaIndex];
        elements.fullscreenContent.innerHTML = "";

        if (media.type === "image") {
            const img = document.createElement("img");
            img.src = media.url;
            elements.fullscreenContent.appendChild(img);
        } else {
            const video = document.createElement("video");
            video.src = media.url;
            video.controls = true;
            video.autoplay = true;
            elements.fullscreenContent.appendChild(video);
        }

        elements.fullscreenPrev.style.display = state.currentMediaIndex > 0 ? "flex" : "none";
        elements.fullscreenNext.style.display = 
            state.currentMediaIndex < state.currentMediaArray.length - 1 ? "flex" : "none";
    },

    closeFullscreen() {
        elements.fullscreenOverlay.classList.remove("active");
        document.body.style.overflow = "";
        const video = elements.fullscreenContent.querySelector("video");
        if (video) video.pause();
    },

    navigatePrev() {
        if (state.currentMediaIndex > 0) {
            state.currentMediaIndex--;
            this.showFullscreenMedia();
        }
    },

    navigateNext() {
        if (state.currentMediaIndex < state.currentMediaArray.length - 1) {
            state.currentMediaIndex++;
            this.showFullscreenMedia();
        }
    }
};

// ============================================================================
// POST MANAGEMENT
// ============================================================================

const postManager = {
    async createPost() {
        const content = elements.postInput.value.trim();
        const heading = elements.postHeading.value.trim();

        if (!content && state.uploadedMedia.length === 0) {
            utils.showError("Please write something or upload media", elements.postError);
            return;
        }

        const filtered = utils.filterProfanity(content);
        const filteredHeading = heading ? utils.filterProfanity(heading) : "";

        try {
            elements.postBtn.disabled = true;

            const displayName = authState.currentUser?.displayName || authState.currentUser?.email || "Anonymous";

            const postData = {
                authorId: authState.currentUser?.uid || "anonymous",
                authorName: displayName,
                content: filtered,
                likes: {},
                media: state.uploadedMedia,
                comments: {}
            };

            if (filteredHeading) {
                postData.heading = filteredHeading;
            }

            if (authState.isAdmin && elements.announcementCheck?.checked) {
                postData.isAnnouncement = true;
            }

            await firestoreOps.createPost(postData);

            elements.postInput.value = "";
            elements.postHeading.value = "";
            if (elements.announcementCheck) elements.announcementCheck.checked = false;
            state.uploadedMedia = [];
            elements.mediaPreview.innerHTML = "";
            elements.postBtn.disabled = false;
        } catch (error) {
            console.error("Error posting:", error);
            utils.showError("Failed to post. Please try again.", elements.postError);
            elements.postBtn.disabled = false;
        }
    },

    async toggleLike(postId, likes, isLiked) {
        try {
            const newLikes = { ...likes };
            const userId = authState.currentUser?.uid || `anon_${Date.now()}`;
            
            if (isLiked) {
                delete newLikes[userId];
            } else {
                newLikes[userId] = true;
            }
            await firestoreOps.updatePost(postId, { likes: newLikes });
        } catch (error) {
            console.error("Error liking post:", error);
        }
    },

    async addComment(postId, commentText, post) {
        if (!commentText.trim()) return;

        const filteredComment = utils.filterProfanity(commentText);

        try {
            const displayName = authState.currentUser?.displayName || authState.currentUser?.email || "Anonymous";

            const newComments = { ...(post.comments || {}) };
            const commentId = Date.now().toString();
            newComments[commentId] = {
                authorId: authState.currentUser?.uid || "anonymous",
                authorName: displayName,
                content: filteredComment,
                timestamp: Date.now()
            };

            await firestoreOps.updatePost(postId, { comments: newComments });
            return true;
        } catch (error) {
            console.error("Error posting comment:", error);
            return false;
        }
    },

    async deletePost(postId, isAuthor) {
        const confirmMsg = authState.isAdmin && !isAuthor
            ? "You are deleting this post as an admin. Continue?"
            : "Are you sure you want to delete this post?";

        if (confirm(confirmMsg)) {
            try {
                await firestoreOps.deletePost(postId);
            } catch (error) {
                console.error("Error deleting post:", error);
                alert("Failed to delete post");
            }
        }
    },

    loadComments(postId, container, comments) {
        container.innerHTML = "";

        const commentArray = Object.entries(comments).map(([id, comment]) => ({
            id,
            ...comment
        }));

        commentArray.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

        commentArray.forEach((comment) => {
            const commentDiv = document.createElement("div");
            commentDiv.className = "comment";

            const commentTime = new Date(comment.timestamp).toLocaleString([], {
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit"
            });

            commentDiv.innerHTML = `
                <div class="comment-header">
                    <div class="comment-avatar">${comment.authorName[0].toUpperCase()}</div>
                    <div class="comment-author">${comment.authorName}</div>
                    <div class="comment-time">${commentTime}</div>
                </div>
                <div class="comment-content">${comment.content}</div>
            `;

            container.appendChild(commentDiv);
        });
    }
};

// ============================================================================
// UI MANAGEMENT
// ============================================================================

const uiManager = {
    displayPost(postId, post) {
        const postDiv = document.createElement("div");
        postDiv.className = "post";
        if (post.isAnnouncement) {
            postDiv.classList.add("announcement");
        }

        const time = utils.formatTime(post.timestamp);
        const likes = post.likes || {};
        const currentUserId = authState.currentUser?.uid;
        const isLiked = currentUserId && likes[currentUserId] === true;
        const likeCount = Object.keys(likes).length;
        const isAuthor = post.authorId === currentUserId;

        const announcementBadge = post.isAnnouncement
            ? '<div class="announcement-badge">📢 ANNOUNCEMENT</div>'
            : "";
        const headingHtml = post.heading ? `<div class="post-heading">${post.heading}</div>` : "";

        let mediaHtml = "";
        if (post.media && post.media.length > 0) {
            const singleClass = post.media.length === 1 ? "single" : "";
            mediaHtml = '<div class="post-media">';
            post.media.forEach((media, index) => {
                if (media.type === "image") {
                    mediaHtml += `
                        <div class="post-media-item ${singleClass}" data-media-index="${index}">
                            <img src="${media.url}" alt="Post media" />
                        </div>
                    `;
                } else {
                    mediaHtml += `
                        <div class="post-media-item ${singleClass}" data-media-index="${index}">
                            <video src="${media.url}" controls></video>
                        </div>
                    `;
                }
            });
            mediaHtml += "</div>";
        }

        const comments = post.comments || {};
        const commentCount = Object.keys(comments).length;
        const commentText = commentCount === 1 ? "1 comment" : `${commentCount} comments`;

        postDiv.innerHTML = `
            ${announcementBadge}
            <div class="post-header">
                <div class="post-avatar">${post.authorName[0].toUpperCase()}</div>
                <div class="post-author-info">
                    <div class="post-author">${post.authorName}</div>
                    <div class="post-time">${time}</div>
                </div>
            </div>
            ${headingHtml}
            <div class="post-content">${post.content}</div>
            ${mediaHtml}
            <div class="post-actions">
                <button class="action-btn ${isLiked ? "liked" : ""}" data-post-id="${postId}" data-action="like">
                    ${isLiked ? "❤️" : "🤍"} ${likeCount > 0 ? likeCount : ""}
                </button>
                <button class="action-btn" data-post-id="${postId}" data-action="comment">
                    💬 ${commentCount > 0 ? commentText : "Comment"}
                </button>
                ${isAuthor || authState.isAdmin ? `<button class="action-btn delete-btn" data-post-id="${postId}" data-action="delete">🗑️ Delete</button>` : ""}
            </div>
            <div class="comments-section" data-post-id="${postId}">
                <div class="comments-container hidden" id="comments-${postId}"></div>
                <div class="comment-input-container hidden" id="comment-input-${postId}">
                    <input type="text" class="comment-input" placeholder="Write a comment..." />
                    <button class="comment-btn">Post</button>
                </div>
            </div>
        `;

        // Media click handlers
        if (post.media && post.media.length > 0) {
            const mediaItems = postDiv.querySelectorAll(".post-media-item");
            mediaItems.forEach((item) => {
                item.addEventListener("click", () => {
                    const index = parseInt(item.dataset.mediaIndex);
                    mediaManager.openFullscreen(post.media, index);
                });
            });
        }

        // Like button
        const likeBtn = postDiv.querySelector('[data-action="like"]');
        likeBtn.addEventListener("click", () => {
            postManager.toggleLike(postId, likes, isLiked);
        });

        // Comment button
        const commentBtn = postDiv.querySelector('[data-action="comment"]');
        const commentsContainer = postDiv.querySelector(`#comments-${postId}`);
        const commentInputContainer = postDiv.querySelector(`#comment-input-${postId}`);

        commentBtn.addEventListener("click", () => {
            const isHidden = commentsContainer.classList.contains("hidden");
            if (isHidden) {
                commentsContainer.classList.remove("hidden");
                commentInputContainer.classList.remove("hidden");
                postManager.loadComments(postId, commentsContainer, post.comments || {});
            } else {
                commentsContainer.classList.add("hidden");
                commentInputContainer.classList.add("hidden");
            }
        });

        // Comment input
        const commentInput = commentInputContainer.querySelector(".comment-input");
        const commentPostBtn = commentInputContainer.querySelector(".comment-btn");

        commentPostBtn.addEventListener("click", async () => {
            const commentText = commentInput.value.trim();
            if (!commentText) return;

            commentPostBtn.disabled = true;
            const success = await postManager.addComment(postId, commentText, post);
            if (success) {
                commentInput.value = "";
            }
            commentPostBtn.disabled = false;
        });

        // Delete button
        if (isAuthor || authState.isAdmin) {
            const deleteBtn = postDiv.querySelector('[data-action="delete"]');
            if (deleteBtn) {
                deleteBtn.addEventListener("click", () => {
                    postManager.deletePost(postId, isAuthor);
                });
            }
        }

        elements.postsContainer.appendChild(postDiv);

        if (commentCount > 0) {
            postManager.loadComments(postId, commentsContainer, post.comments || {});
        }
    },

    loadPosts() {
        firestoreOps.subscribeToPosts((snapshot) => {
            elements.postsContainer.innerHTML = "";

            if (snapshot.empty) {
                elements.postsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>No posts yet</h3>
                        <p>Be the first to share something with the community!</p>
                    </div>
                `;
                return;
            }

            snapshot.forEach((docSnap) => {
                const post = docSnap.data();
                this.displayPost(docSnap.id, post);
            });
        });
    }
};

// ============================================================================
// EVENT LISTENERS (For Posts)
// ============================================================================

function setupEventListeners() {
    // Post button
    elements.postBtn?.addEventListener("click", () => {
        postManager.createPost();
    });

    // Media upload
    elements.uploadImageBtn?.addEventListener("click", () => elements.imageInput.click());
    elements.uploadVideoBtn?.addEventListener("click", () => elements.videoInput.click());

    elements.imageInput?.addEventListener("change", async (e) => {
        await cloudinaryManager.handleFileUpload(e.target.files, "image");
        elements.imageInput.value = "";
    });

    elements.videoInput?.addEventListener("change", async (e) => {
        await cloudinaryManager.handleFileUpload(e.target.files, "video");
        elements.videoInput.value = "";
    });

    // Fullscreen controls
    elements.fullscreenClose?.addEventListener("click", () => {
        mediaManager.closeFullscreen();
    });

    elements.fullscreenPrev?.addEventListener("click", () => {
        mediaManager.navigatePrev();
    });

    elements.fullscreenNext?.addEventListener("click", () => {
        mediaManager.navigateNext();
    });

    elements.fullscreenOverlay?.addEventListener("click", (e) => {
        if (e.target === elements.fullscreenOverlay) {
            mediaManager.closeFullscreen();
        }
    });
}

// ============================================================================
// INITIALIZATION
// ============================================================================

function initialize() {
    console.log("Initializing application...");
    
    // Initialize authentication first
    initializeAuth();
    
    // Setup post event listeners
    setupEventListeners();
    
    // Expose to window
    window.authManager = authManager;
    window.authUIManager = authUIManager;
    window.postManager = postManager;
    window.mediaManager = mediaManager;
    
    console.log("Application initialized");
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
} else {
    initialize();
}

</script>
</body>
</html>
